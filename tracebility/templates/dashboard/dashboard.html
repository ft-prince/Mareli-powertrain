{% extends 'dashboard/base.html' %}

{% load machine_filters %}
{% block title %}Dashboard - Manufacturing Traceability{% endblock %}

{% block content %}
<h2 style="margin-bottom: 1.5rem; color: var(--dark-blue);">
    Production Line Machines
    <span id="connectionStatus" style="font-size: 0.8rem; margin-left: 1rem;">
        <span class="status-indicator status-active"></span> Live
    </span>
</h2>

<!-- Machine Group Selection -->
<div class="machine-groups-container" style="margin-bottom: 2rem;">
    <div class="machine-groups-header" style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
        <button class="group-button active" onclick="filterMachineGroup('all')" data-group="all">
            <span class="group-icon">üè≠</span>
            <span class="group-name">All Machines</span>
            <span class="group-count" id="count-all">0</span>
        </button>
        <button class="group-button" onclick="filterMachineGroup('dmg_mori')" data-group="dmg_mori">
            <span class="group-icon">‚öôÔ∏è</span>
            <span class="group-name">DMG MORI</span>
            <span class="group-count" id="count-dmg_mori">0</span>
        </button>
        <button class="group-button" onclick="filterMachineGroup('gauge')" data-group="gauge">
            <span class="group-icon">üìè</span>
            <span class="group-name">Gauge</span>
            <span class="group-count" id="count-gauge">0</span>
        </button>
        <button class="group-button" onclick="filterMachineGroup('honing')" data-group="honing">
            <span class="group-icon">üîß</span>
            <span class="group-name">Honing</span>
            <span class="group-count" id="count-honing">0</span>
        </button>
        <button class="group-button" onclick="filterMachineGroup('washing')" data-group="washing">
            <span class="group-icon">üíß</span>
            <span class="group-name">Washing</span>
            <span class="group-count" id="count-washing">0</span>
        </button>
        <button class="group-button" onclick="filterMachineGroup('processing')" data-group="processing">
            <span class="group-icon">üî®</span>
            <span class="group-name">Processing</span>
            <span class="group-count" id="count-processing">0</span>
        </button>
        <button class="group-button" onclick="filterMachineGroup('assembly')" data-group="assembly">
            <span class="group-icon">üî©</span>
            <span class="group-name">Assembly (OP40)</span>
            <span class="group-count" id="count-assembly">0</span>
        </button>
        <button class="group-button" onclick="filterMachineGroup('special')" data-group="special">
            <span class="group-icon">‚≠ê</span>
            <span class="group-name">Special Ops</span>
            <span class="group-count" id="count-special">0</span>
        </button>
    </div>
</div>

<!-- Machine Cards Grid -->
<div class="machine-grid" id="machineGrid">
    {% for machine in machines %}
    <div class="machine-grid-card" 
         id="machine-card-{{ machine.machine_id }}" 
         data-machine-group="{{ machine.machine_id|get_machine_group }}"
         onclick="openMachineModal('{{ machine.machine_id }}', '{{ machine.display_name }}')" 
         style="cursor: pointer;">
        
        <!-- Card Header with Name and IP -->
        <div class="machine-grid-header" style="display: flex; flex-direction: column; gap: 0.5rem;">
            <div class="machine-grid-title" style="display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span class="status-indicator {% if machine.is_active %}status-active{% else %}status-inactive{% endif %}"></span>
                    <span style="font-size: 1.1rem; font-weight: 600;">{{ machine.name }}</span>
                </div>
                <span class="machine-type-badge type-{{ machine.type }}">{{ machine.ip|upper }}</span>
            </div>
            
            <!-- Machine Details Row -->
            <div style="display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.75rem; color: var(--dark-gray); padding-left: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="opacity: 0.8;">üåê</span>
                    <span style="font-family: 'Courier New', monospace;">{{ machine.ip }}</span>
                    <span style="opacity: 0.6;">|</span>
                    <span style="opacity: 0.8;">{{ machine.op_code }}</span>
                </div>
            </div>
        </div>
        
        <!-- Latest Data Section -->
        <div class="machine-data-section" data-machine-id="{{ machine.machine_id }}">
        {% if machine.latest_record %}
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--light-gray);">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--dark-gray); font-size: 0.85rem;">
                    {% if 'Painting' in machine.name %}QR Housing:
                    {% elif 'Lubrication' in machine.name %}QR Piston:
                    {% elif 'Oring_leak' in machine.name %}QR Piston:
                    {% else %}Latest QR:{% endif %}
                </span>
                <strong style="font-size: 0.85rem;">{{ machine.latest_record.qr_code }}</strong>
            </div>
            
            {% if 'Painting' in machine.name and machine.latest_record.qr_piston %}
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--dark-gray); font-size: 0.85rem;">QR Piston:</span>
                <span style="font-size: 0.85rem;">{{ machine.latest_record.qr_piston }}</span>
            </div>
            {% endif %}
            
            {% if 'Lubrication' in machine.name and machine.latest_record.qr_housing %}
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--dark-gray); font-size: 0.85rem;">QR Housing:</span>
                <span style="font-size: 0.85rem;">{{ machine.latest_record.qr_housing }}</span>
            </div>
            {% endif %}
            
            {% if 'Oring_leak' in machine.name and machine.latest_record.qr_housing %}
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--dark-gray); font-size: 0.85rem;">QR Housing:</span>
                <span style="font-size: 0.85rem;">{{ machine.latest_record.qr_housing }}</span>
            </div>
            {% endif %}
            
            <div style="display: flex; flex-direction: column; gap: 0.25rem; margin-bottom: 0.5rem;">
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--dark-gray); font-size: 0.85rem;">Date:</span>
                    <span style="font-size: 0.85rem;" data-timestamp-date="{{ machine.latest_record.prep_timestamp }}"></span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--dark-gray); font-size: 0.85rem;">Time:</span>
                    <span style="font-size: 0.85rem;" data-timestamp-time="{{ machine.latest_record.prep_timestamp }}"></span>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--dark-gray); font-size: 0.85rem;">Status:</span>
                {% if machine.latest_record.post_status == "OK" %}
                    <span class="status-badge status-ok" style="font-size: 0.8rem;">‚úÖ OK</span>
                {% elif machine.latest_record.post_status == "NG" %}
                    <span class="status-badge status-ng" style="font-size: 0.8rem;">‚ùå NG</span>
                {% else %}
                    <span class="status-badge status-inprogress" style="font-size: 0.8rem;">‚è≥ Pending</span>
                {% endif %}
            </div>
            
            {% if machine.latest_record.gauge_values %}
            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f0f0f0;">
                <div style="color: var(--dark-gray); font-size: 0.8rem; margin-bottom: 0.5rem;">Gauge Values:</div>
                {% for key, value in machine.latest_record.gauge_values.items %}
                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                    <span>{{ key }}:</span>
                    <span style="font-weight: 600;">{{ value|floatformat:3 }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if machine.is_assembly and machine.latest_record.qr_external != '-' %}
            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f0f0f0; font-size: 0.75rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span style="color: var(--dark-gray);">External:</span>
                    <span>{{ machine.latest_record.qr_external }}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--dark-gray);">Housing:</span>
                    <span>{{ machine.latest_record.qr_housing }}</span>
                </div>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div style="margin-top: 1rem; color: var(--dark-gray); font-style: italic; text-align: center;">
            No data available
        </div>
        {% endif %}
        </div>
        
        <!-- Status Section -->
        <div class="machine-status-section" data-machine-id="{{ machine.machine_id }}" style="margin-top: 1rem; font-size: 0.9rem;">
            {% if machine.is_active %}
                <span style="color: var(--success-green); font-weight: 600;">‚óè ACTIVE</span>
            {% else %}
                <span style="color: var(--danger-red); font-weight: 600;">‚óè INACTIVE</span>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Fullscreen Machine Detail Modal -->
<div id="machineModal" class="modal">
    <div class="modal-content" style="max-width: 100%; width: 95%; height:97%">
        <span class="modal-close" onclick="closeMachineModal()">&times;</span>
        <h2 id="machineModalTitle">
            Machine Details
            <span id="modalConnectionStatus" style="font-size: 0.8rem; margin-left: 1rem;">
                <span class="status-indicator status-active"></span> Live
            </span>
        </h2>
        
        <div class="modal-body">
            <div id="machineModalContent">
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 2rem;">‚è≥</div>
                    <p>Loading machine data...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Group Button Styles */
.machine-groups-container {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.group-button {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 1.5rem;
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 120px;
}

.group-button:hover {
    border-color: var(--primary-blue);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,102,204,0.2);
}

.group-button.active {
    background: var(--primary-blue);
    border-color: var(--primary-blue);
    color: white;
}

.group-button.active .group-count {
    background: white;
    color: var(--primary-blue);
}

.group-icon {
    font-size: 1.5rem;
}

.group-name {
    font-size: 0.85rem;
    font-weight: 600;
    text-align: center;
}

.group-count {
    background: var(--light-gray);
    color: var(--dark-blue);
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 700;
}

/* Machine card hidden state for filtering */
.machine-grid-card.hidden {
    display: none !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .machine-groups-header {
        justify-content: center;
    }
    
    .group-button {
        min-width: 100px;
        padding: 0.75rem 1rem;
    }
    
    .group-icon {
        font-size: 1.25rem;
    }
    
    .group-name {
        font-size: 0.75rem;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
let currentMachineId = null;
let currentMachineType = null;
let dashboardEventSource = null;
let machineEventSource = null;
let currentGroup = 'all';

// Machine grouping logic
function getMachineGroup(machineId) {
    if (machineId.includes('dmg_mori')) return 'dmg_mori';
    if (machineId.includes('gauge')) return 'gauge';
    if (machineId.includes('honing')) return 'honing';
    if (machineId.includes('prewashing') || machineId.includes('finalwashing') || machineId.includes('finlwashing')) return 'washing';
    if (machineId.includes('deburring')) return 'processing';
    if (machineId.includes('op40')) return 'assembly';
    if (machineId.includes('op80') || machineId.includes('painting') || machineId.includes('lubrication')) return 'special';
    return 'other';
}

// Filter machines by group
function filterMachineGroup(group) {
    currentGroup = group;
    
    // Update active button
    document.querySelectorAll('.group-button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-group="${group}"]`).classList.add('active');
    
    // Filter machine cards
    const allCards = document.querySelectorAll('.machine-grid-card');
    
    allCards.forEach(card => {
        const cardGroup = card.getAttribute('data-machine-group');
        
        if (group === 'all' || cardGroup === group) {
            card.classList.remove('hidden');
        } else {
            card.classList.add('hidden');
        }
    });
}

// Update group counts
function updateGroupCounts() {
    const groups = {
        all: 0,
        dmg_mori: 0,
        gauge: 0,
        honing: 0,
        washing: 0,
        processing: 0,
        assembly: 0,
        special: 0
    };
    
    document.querySelectorAll('.machine-grid-card').forEach(card => {
        const group = card.getAttribute('data-machine-group');
        groups.all++;
        if (groups[group] !== undefined) {
            groups[group]++;
        }
    });
    
    // Update count badges
    Object.keys(groups).forEach(group => {
        const countEl = document.getElementById(`count-${group}`);
        if (countEl) {
            countEl.textContent = groups[group];
        }
    });
}

// Parse timestamp string "10/11/2025, 3:40:33 pm" to Date object
function parseCustomTimestamp(timestamp) {
    if (!timestamp) return null;
    
    try {
        // Already a Date object
        if (timestamp instanceof Date) return timestamp;
        
        // Try standard ISO format first
        if (timestamp.includes('T') || (timestamp.includes('-') && !timestamp.includes(','))) {
            const date = new Date(timestamp);
            if (!isNaN(date.getTime())) return date;
        }
        
        // Parse custom format: "10/11/2025, 3:40:33 pm" or "10/11/2025, 3:40:33 PM"
        const match = timestamp.match(/(\d{1,2})\/(\d{1,2})\/(\d{4}),?\s+(\d{1,2}):(\d{2}):(\d{2})\s*(am|pm|AM|PM)/i);
        if (match) {
            let [, day, month, year, hour, minute, second, meridiem] = match;
            
            // Convert to numbers
            day = parseInt(day);
            month = parseInt(month);
            year = parseInt(year);
            hour = parseInt(hour);
            minute = parseInt(minute);
            second = parseInt(second);
            
            // Convert 12-hour to 24-hour format
            if (meridiem.toLowerCase() === 'pm' && hour !== 12) {
                hour += 12;
            } else if (meridiem.toLowerCase() === 'am' && hour === 12) {
                hour = 0;
            }
            
            // Try DD/MM/YYYY format first (more common internationally)
            let date = new Date(year, month - 1, day, hour, minute, second);
            if (!isNaN(date.getTime()) && date.getDate() === day) {
                return date;
            }
            
            // Try MM/DD/YYYY format (US format)
            date = new Date(year, day - 1, month, hour, minute, second);
            if (!isNaN(date.getTime())) {
                return date;
            }
        }
        
        // Fallback: try native Date parsing
        const date = new Date(timestamp);
        if (!isNaN(date.getTime())) return date;
        
        return null;
    } catch (e) {
        console.error('Error parsing timestamp:', e, timestamp);
        return null;
    }
}

// Format date only (e.g., "Nov 10, 2025")
function formatDate(timestamp) {
    if (!timestamp) return '-';
    
    const date = parseCustomTimestamp(timestamp);
    if (!date) return timestamp;
    
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
    });
}

// Format time only in 12-hour format (e.g., "3:40:33 PM")
function formatTime(timestamp) {
    if (!timestamp) return '-';
    
    const date = parseCustomTimestamp(timestamp);
    if (!date) return timestamp;
    
    return date.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
    });
}

// Format full date and time (e.g., "Nov 10, 2025, 3:40:33 PM")
function formatDateTime(timestamp) {
    if (!timestamp) return '-';
    
    const date = parseCustomTimestamp(timestamp);
    if (!date) return timestamp;
    
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
    }) + ', ' + date.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
    });
}

// Format timestamps on page load
function formatAllTimestamps() {
    // Format date elements
    document.querySelectorAll('[data-timestamp-date]').forEach(element => {
        const timestamp = element.getAttribute('data-timestamp-date');
        element.textContent = formatDate(timestamp);
    });
    
    // Format time elements
    document.querySelectorAll('[data-timestamp-time]').forEach(element => {
        const timestamp = element.getAttribute('data-timestamp-time');
        element.textContent = formatTime(timestamp);
    });
    
    // Format full datetime elements
    document.querySelectorAll('[data-timestamp-full]').forEach(element => {
        const timestamp = element.getAttribute('data-timestamp-full');
        element.textContent = formatDateTime(timestamp);
    });
}

// Initialize dashboard real-time updates
function initDashboardStream() {
    if (dashboardEventSource) {
        dashboardEventSource.close();
    }
    
    dashboardEventSource = new EventSource('/stream/dashboard/');
    
    dashboardEventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            if (data.type === 'update' && data.machines) {
                updateDashboardMachines(data.machines);
            }
        } catch (error) {
            console.error('Error parsing dashboard update:', error);
        }
    };
    
    dashboardEventSource.onerror = function(error) {
        console.error('Dashboard stream error:', error);
        updateConnectionStatus(false);
        
        // Attempt to reconnect after 5 seconds
        setTimeout(() => {
            console.log('Attempting to reconnect dashboard stream...');
            initDashboardStream();
        }, 5000);
    };
    
    dashboardEventSource.onopen = function() {
        console.log('Dashboard stream connected');
        updateConnectionStatus(true);
    };
}

// Update connection status indicator
function updateConnectionStatus(connected) {
    const statusEl = document.getElementById('connectionStatus');
    if (statusEl) {
        const indicator = statusEl.querySelector('.status-indicator');
        if (connected) {
            indicator.className = 'status-indicator status-active';
            statusEl.innerHTML = '<span class="status-indicator status-active"></span> Live';
        } else {
            indicator.className = 'status-indicator status-inactive';
            statusEl.innerHTML = '<span class="status-indicator status-inactive"></span> Reconnecting...';
        }
    }
}

// Update modal connection status
function updateModalConnectionStatus(connected) {
    const statusEl = document.getElementById('modalConnectionStatus');
    if (statusEl) {
        if (connected) {
            statusEl.innerHTML = '<span class="status-indicator status-active"></span> Live';
        } else {
            statusEl.innerHTML = '<span class="status-indicator status-inactive"></span> Reconnecting...';
        }
    }
}

// Helper function to get machine name from card
function getMachineName(machineId) {
    const card = document.getElementById(`machine-card-${machineId}`);
    if (card) {
        const title = card.querySelector('.machine-grid-title');
        if (title) {
            // Extract text, removing the status indicator
            return title.textContent.trim();
        }
    }
    return '';
}

// Update dashboard machine cards with real-time data
function updateDashboardMachines(machines) {
    machines.forEach(machine => {
        const card = document.getElementById(`machine-card-${machine.machine_id}`);
        if (!card) return;
        
        const machineName = machine.display_name || getMachineName(machine.machine_id);
        
        // Add subtle animation for update
        card.style.transition = 'box-shadow 0.3s ease';
        card.style.boxShadow = '0 0 15px rgba(0, 102, 204, 0.3)';
        setTimeout(() => {
            card.style.boxShadow = '';
        }, 1000);
        
        // Update the machine card HTML with fresh data
        const machineHeader = card.querySelector('.machine-grid-header');
        const statusIndicator = machineHeader.querySelector('.status-indicator');
        
        // Update status indicator in header
        if (statusIndicator && machine.is_active !== undefined) {
            statusIndicator.className = machine.is_active ? 
                'status-indicator status-active' : 
                'status-indicator status-inactive';
        }
        
        // Find sections using data attributes (more reliable)
        const dataSection = card.querySelector(`.machine-data-section[data-machine-id="${machine.machine_id}"]`);
        const activeStatusSection = card.querySelector(`.machine-status-section[data-machine-id="${machine.machine_id}"]`);
        
        // Update latest record section
        if (dataSection) {
            if (machine.latest_record) {
                let qrLabel = 'Latest QR:';
                if (machine.name && machine.name.includes('Painting')) qrLabel = 'QR Housing:';
                else if (machine.name && machine.name.includes('Lubrication')) qrLabel = 'QR Piston:';
                else if (machine.name && machine.name.includes('Oring_leak')) qrLabel = 'QR Piston:';
                
                let recordHTML = `
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--light-gray);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--dark-gray); font-size: 0.85rem;">${qrLabel}</span>
                            <strong style="font-size: 0.85rem;">${machine.latest_record.qr_code}</strong>
                        </div>
                `;
                
                // Add additional QR codes for special machines
                if (machine.name && machine.name.includes('Painting') && machine.latest_record.qr_piston) {
                    recordHTML += `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--dark-gray); font-size: 0.85rem;">QR Piston:</span>
                            <span style="font-size: 0.85rem;">${machine.latest_record.qr_piston}</span>
                        </div>
                    `;
                }
                
                if (machine.name && machine.name.includes('Lubrication') && machine.latest_record.qr_housing) {
                    recordHTML += `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--dark-gray); font-size: 0.85rem;">QR Housing:</span>
                            <span style="font-size: 0.85rem;">${machine.latest_record.qr_housing}</span>
                        </div>
                    `;
                }
                
                if (machine.name && machine.name.includes('Oring_leak') && machine.latest_record.qr_housing) {
                    recordHTML += `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--dark-gray); font-size: 0.85rem;">QR Housing:</span>
                            <span style="font-size: 0.85rem;">${machine.latest_record.qr_housing}</span>
                        </div>
                    `;
                }
                
                recordHTML += `
                        <div style="display: flex; flex-direction: column; gap: 0.25rem; margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--dark-gray); font-size: 0.85rem;">Date:</span>
                                <span style="font-size: 0.85rem;">${formatDate(machine.latest_record.prep_timestamp)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--dark-gray); font-size: 0.85rem;">Time:</span>
                                <span style="font-size: 0.85rem;">${formatTime(machine.latest_record.prep_timestamp)}</span>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--dark-gray); font-size: 0.85rem;">Status:</span>
                `;
                
                // Add status badge
                if (machine.latest_record.post_status === 'OK') {
                    recordHTML += '<span class="status-badge status-ok" style="font-size: 0.8rem;">‚úÖ OK</span>';
                } else if (machine.latest_record.post_status === 'NG') {
                    recordHTML += '<span class="status-badge status-ng" style="font-size: 0.8rem;">‚ùå NG</span>';
                } else {
                    recordHTML += '<span class="status-badge status-inprogress" style="font-size: 0.8rem;">‚è≥ Pending</span>';
                }
                recordHTML += '</div>';
                
                // Add gauge values if present
                if (machine.latest_record.gauge_values && Object.keys(machine.latest_record.gauge_values).length > 0) {
                    recordHTML += `
                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f0f0f0;">
                            <div style="color: var(--dark-gray); font-size: 0.8rem; margin-bottom: 0.5rem;">Gauge Values:</div>
                    `;
                    for (const [key, value] of Object.entries(machine.latest_record.gauge_values)) {
                        recordHTML += `
                            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                                <span>${key}:</span>
                                <span style="font-weight: 600;">${parseFloat(value).toFixed(3)}</span>
                            </div>
                        `;
                    }
                    recordHTML += '</div>';
                }
                
                // Add assembly QR codes if present
                if (machine.is_assembly && machine.latest_record.qr_external && machine.latest_record.qr_external !== '-') {
                    recordHTML += `
                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f0f0f0; font-size: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span style="color: var(--dark-gray);">External:</span>
                                <span>${machine.latest_record.qr_external}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--dark-gray);">Housing:</span>
                                <span>${machine.latest_record.qr_housing}</span>
                            </div>
                        </div>
                    `;
                }
                
                recordHTML += '</div>';
                dataSection.innerHTML = recordHTML;
            } else {
                dataSection.innerHTML = '<div style="margin-top: 1rem; color: var(--dark-gray); font-style: italic; text-align: center;">No data available</div>';
            }
        }
        
        // Update active/inactive status
        if (activeStatusSection) {
            if (machine.is_active) {
                activeStatusSection.innerHTML = '<span style="color: var(--success-green); font-weight: 600;">‚óè ACTIVE</span>';
            } else {
                activeStatusSection.innerHTML = '<span style="color: var(--danger-red); font-weight: 600;">‚óè INACTIVE</span>';
            }
        }
    });
}

// Initialize machine modal real-time updates
function initMachineStream(machineId) {
    if (machineEventSource) {
        machineEventSource.close();
    }
    
    machineEventSource = new EventSource(`/stream/machine/${machineId}/`);
    
    machineEventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            if (data.type === 'update') {
                currentMachineType = data.machine_type || 'standard';
                renderMachineData(data);
                
                // Add visual feedback for update
                const content = document.getElementById('machineModalContent');
                if (content) {
                    content.style.transition = 'opacity 0.2s ease';
                    content.style.opacity = '0.7';
                    setTimeout(() => {
                        content.style.opacity = '1';
                    }, 200);
                }
            }
        } catch (error) {
            console.error('Error parsing machine update:', error);
        }
    };
    
    machineEventSource.onerror = function(error) {
        console.error('Machine stream error:', error);
        updateModalConnectionStatus(false);
        
        // Attempt to reconnect after 5 seconds
        setTimeout(() => {
            if (currentMachineId === machineId) {
                console.log('Attempting to reconnect machine stream...');
                initMachineStream(machineId);
            }
        }, 5000);
    };
    
    machineEventSource.onopen = function() {
        console.log('Machine stream connected');
        updateModalConnectionStatus(true);
    };
}

function openMachineModal(machineId, machineName) {
    currentMachineId = machineId;
    document.getElementById('machineModalTitle').innerHTML = `
        ${machineName}
        <span id="modalConnectionStatus" style="font-size: 0.8rem; margin-left: 1rem;">
            <span class="status-indicator status-active"></span> Connecting...
        </span>
    `;
    document.getElementById('machineModal').style.display = 'flex';
    
    // Load initial machine data
    fetch(`/api/machine/${machineId}/`)
        .then(response => response.json())
        .then(data => {
            currentMachineType = data.machine_type || 'standard';
            renderMachineData(data);
            // Start real-time updates
            initMachineStream(machineId);
        })
        .catch(error => {
            document.getElementById('machineModalContent').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--danger-red);">
                    <div style="font-size: 2rem;">‚ö†Ô∏è</div>
                    <p>Error loading machine data</p>
                </div>
            `;
        });
}

function closeMachineModal() {
    document.getElementById('machineModal').style.display = 'none';
    currentMachineId = null;
    currentMachineType = null;
    
    // Close machine stream
    if (machineEventSource) {
        machineEventSource.close();
        machineEventSource = null;
    }
}

function renderMachineData(data) {
    const content = document.getElementById('machineModalContent');
    
    if (!data.records || data.records.length === 0) {
        content.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
                <div style="font-size: 2rem;">üìä</div>
                <h3>No data available</h3>
                <p>Waiting for production data...</p>
            </div>
        `;
        return;
    }
    
    const machineType = data.machine_type || currentMachineType || 'standard';
    
    let isPainting = machineType === 'painting';
    let isOP80 = machineType === 'op80';
    let isLubrication = machineType === 'lubrication';
    let isAssembly = machineType === 'assembly';
    
    // Build the table
    let tableHTML = `
        <div class="data-table-container" style="max-height: 90vh; overflow-y: auto;">
            <table class="data-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th colspan="4" style="background: rgba(0, 102, 204, 0.1); text-align: center; padding: 8px; border: 1px solid #ddd;">Preprocessing</th>
    `;
    
    // QR Code columns header
    if (isAssembly) {
        tableHTML += `<th colspan="3" style="background: rgba(200, 200, 200, 0.3); text-align: center; padding: 8px; border: 1px solid #ddd;">QR Codes</th>`;
    } else if (isPainting || isLubrication || isOP80) {
        tableHTML += `<th colspan="2" style="background: rgba(200, 200, 200, 0.3); text-align: center; padding: 8px; border: 1px solid #ddd;">QR Codes</th>`;
    } else {
        tableHTML += `<th style="background: rgba(200, 200, 200, 0.3); text-align: center; padding: 8px; border: 1px solid #ddd;">QR Code</th>`;
    }
    
    // Postprocessing columns header
    if (isOP80) {
        tableHTML += `<th colspan="5" style="background: rgba(0, 168, 204, 0.1); text-align: center; padding: 8px; border: 1px solid #ddd;">Postprocessing</th>`;
    } else {
        tableHTML += `<th colspan="4" style="background: rgba(0, 168, 204, 0.1); text-align: center; padding: 8px; border: 1px solid #ddd;">Postprocessing</th>`;
    }
    
    tableHTML += `
                    </tr>
                    <tr>
                        <th style="background: rgba(0, 102, 204, 0.05); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">ID</th>
                        <th style="background: rgba(0, 102, 204, 0.05); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Date</th>
                        <th style="background: rgba(0, 102, 204, 0.05); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Time</th>
                        <th style="background: rgba(0, 102, 204, 0.05); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Status</th>
    `;
    
    // QR Code column headers
    if (isAssembly) {
        tableHTML += `
            <th style="background: rgba(200, 200, 200, 0.2); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Internal</th>
            <th style="background: rgba(200, 200, 200, 0.2); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">External</th>
            <th style="background: rgba(200, 200, 200, 0.2); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Housing</th>
        `;
    } else if (isPainting) {
        tableHTML += `
            <th style="background: rgba(200, 200, 200, 0.2); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Housing</th>
            <th style="background: rgba(200, 200, 200, 0.2); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Piston</th>
        `;
    } else if (isLubrication) {
        tableHTML += `
            <th style="background: rgba(200, 200, 200, 0.2); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Piston</th>
            <th style="background: rgba(200, 200, 200, 0.2); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Housing</th>
        `;
    } else if (isOP80) {
        tableHTML += `
            <th style="background: rgba(200, 200, 200, 0.2); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Piston</th>
            <th style="background: rgba(200, 200, 200, 0.2); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Housing</th>
        `;
    } else {
        tableHTML += `<th style="background: rgba(200, 200, 200, 0.2); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">QR Code</th>`;
    }
    
    // Postprocessing column headers
    tableHTML += `
            <th style="background: rgba(0, 168, 204, 0.05); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">ID</th>
            <th style="background: rgba(0, 168, 204, 0.05); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Date</th>
            <th style="background: rgba(0, 168, 204, 0.05); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Time</th>
    `;
    
    if (isOP80) {
        tableHTML += `<th style="background: rgba(0, 168, 204, 0.05); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Match</th>`;
    }
    
    tableHTML += `
            <th style="background: rgba(0, 168, 204, 0.05); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Render data rows
    data.records.forEach(record => {
        const prepDate = formatDate(record.prep_timestamp);
        const prepTime = formatTime(record.prep_timestamp);
        const postDate = record.post_timestamp ? formatDate(record.post_timestamp) : '-';
        const postTime = record.post_timestamp ? formatTime(record.post_timestamp) : '-';
        
        tableHTML += `
            <tr>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${record.prep_id}</td>
                <td style="padding: 8px; border: 1px solid #ddd;"><small>${prepDate}</small></td>
                <td style="padding: 8px; border: 1px solid #ddd;"><small>${prepTime}</small></td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span class="status-badge status-ok">‚úÖ ${record.prep_status || 'OK'}</span></td>
        `;
        
        // QR Code cells
        if (isAssembly) {
            tableHTML += `
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><strong>${record.qr_code || '-'}</strong></td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><strong>${record.qr_external || '-'}</strong></td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><strong>${record.qr_housing || '-'}</strong></td>
            `;
        } else if (isPainting) {
            tableHTML += `
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><strong>${record.qr_code || '-'}</strong></td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><strong>${record.qr_piston || '-'}</strong></td>
            `;
        } else if (isLubrication) {
            tableHTML += `
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><strong>${record.qr_code || '-'}</strong></td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><strong>${record.qr_housing || '-'}</strong></td>
            `;
        } else if (isOP80) {
            tableHTML += `
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><strong>${record.qr_code || '-'}</strong></td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><strong>${record.qr_housing || '-'}</strong></td>
            `;
        } else {
            tableHTML += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><strong>${record.qr_code || '-'}</strong></td>`;
        }
        
        // Postprocessing cells
        tableHTML += `
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${record.post_id || '-'}</td>
                <td style="padding: 8px; border: 1px solid #ddd;"><small>${postDate}</small></td>
                <td style="padding: 8px; border: 1px solid #ddd;"><small>${postTime}</small></td>
        `;
        
        if (isOP80 && record.match_status) {
            const matchBadge = (record.match_status === 'TRUE' || record.match_status === 'true') ? 
                '<span class="status-badge status-ok">‚úÖ Match</span>' : 
                '<span class="status-badge status-ng">‚ùå No Match</span>';
            tableHTML += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${matchBadge}</td>`;
        }
        
        // Status cell
        let statusCell = '-';
        if (record.post_status === 'Pending' || !record.post_status) {
            statusCell = '<span class="status-badge status-inprogress">‚è≥ Pending</span>';
        } else if (record.post_status === 'OK') {
            statusCell = '<span class="status-badge status-ok">‚úÖ OK</span>';
            if (record.gauge_values && Object.keys(record.gauge_values).length > 0) {
                statusCell += '<br><small>';
                for (const [key, value] of Object.entries(record.gauge_values)) {
                    statusCell += `${key}: ${parseFloat(value).toFixed(3)}<br>`;
                }
                statusCell += '</small>';
            }
        } else if (record.post_status === 'NG') {
            statusCell = '<span class="status-badge status-ng">‚ùå NG</span>';
        }
        
        tableHTML += `
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${statusCell}</td>
            </tr>
        `;
    });
    
    tableHTML += `
                </tbody>
            </table>
        </div>
    `;
    
    content.innerHTML = tableHTML;
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('machineModal');
    if (event.target == modal) {
        closeMachineModal();
    }
}

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeMachineModal();
    }
});

// Initialize dashboard stream and format timestamps on page load
document.addEventListener('DOMContentLoaded', function() {
    // Assign groups to all cards
    document.querySelectorAll('.machine-grid-card').forEach(card => {
        const machineId = card.id.replace('machine-card-', '');
        const group = getMachineGroup(machineId);
        card.setAttribute('data-machine-group', group);
    });
    
    formatAllTimestamps();
    updateGroupCounts();
    initDashboardStream();
});

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    if (dashboardEventSource) {
        dashboardEventSource.close();
    }
    if (machineEventSource) {
        machineEventSource.close();
    }
});
</script>
{% endblock %}
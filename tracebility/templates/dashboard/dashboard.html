{% extends 'dashboard/base.html' %}

{% load machine_filters %}
{% block title %}Dashboard - Manufacturing Traceability{% endblock %}

{% block content %}
<h2 style="margin-bottom: 1.5rem; color: var(--dark-blue);">
    Production Line Machines
    <span id="connectionStatus" style="font-size: 0.8rem; margin-left: 1rem;">
        <span class="status-indicator status-active"></span> Live
    </span>
</h2>

<!-- Machine Group Selection -->
<div class="machine-groups-container" style="margin-bottom: 2rem;">
    <div class="machine-groups-header" style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
        <button class="group-button active" onclick="filterMachineGroup('all')" data-group="all">
            <span class="group-icon">üè≠</span>
            <span class="group-name">All Machines</span>
            <span class="group-count" id="count-all">0</span>
        </button>
        <button class="group-button" onclick="filterMachineGroup('dmg_mori')" data-group="dmg_mori">
            <span class="group-icon">‚öôÔ∏è</span>
            <span class="group-name">DMG MORI</span>
            <span class="group-count" id="count-dmg_mori">0</span>
        </button>
        <button class="group-button" onclick="filterMachineGroup('gauge')" data-group="gauge">
            <span class="group-icon">üìè</span>
            <span class="group-name">Gauge</span>
            <span class="group-count" id="count-gauge">0</span>
        </button>
        <button class="group-button" onclick="filterMachineGroup('honing')" data-group="honing">
            <span class="group-icon">üîß</span>
            <span class="group-name">Honing</span>
            <span class="group-count" id="count-honing">0</span>
        </button>
        <button class="group-button" onclick="filterMachineGroup('washing')" data-group="washing">
            <span class="group-icon">üíß</span>
            <span class="group-name">Washing</span>
            <span class="group-count" id="count-washing">0</span>
        </button>
        <button class="group-button" onclick="filterMachineGroup('processing')" data-group="processing">
            <span class="group-icon">üî®</span>
            <span class="group-name">Processing</span>
            <span class="group-count" id="count-processing">0</span>
        </button>
        <button class="group-button" onclick="filterMachineGroup('assembly')" data-group="assembly">
            <span class="group-icon">üî©</span>
            <span class="group-name">Assembly (OP40)</span>
            <span class="group-count" id="count-assembly">0</span>
        </button>
        <button class="group-button" onclick="filterMachineGroup('special')" data-group="special">
            <span class="group-icon">‚≠ê</span>
            <span class="group-name">Special Ops</span>
            <span class="group-count" id="count-special">0</span>
        </button>
    </div>
</div>

<!-- Machine Cards Grid -->
<div class="machine-grid" id="machineGrid">
    {% for machine in machines %}
    <div class="machine-grid-card" 
         id="machine-card-{{ machine.machine_id }}" 
         data-machine-group="{{ machine.machine_id|get_machine_group }}"
         onclick="openMachineModal('{{ machine.machine_id }}', '{{ machine.display_name }}')" 
         style="cursor: pointer;">
        
        <!-- Card Header with Name and IP -->
        <div class="machine-grid-header" style="display: flex; flex-direction: column; gap: 0.5rem;">
            <div class="machine-grid-title" style="display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span class="status-indicator {% if machine.is_active %}status-active{% else %}status-inactive{% endif %}"></span>
                    <span style="font-size: 1.1rem; font-weight: 600;">{{ machine.display_name }}</span>
                </div>
                <span class="machine-type-badge type-{{ machine.type }}">{{ machine.op_code|upper }}</span>
            </div>
            
            <!-- Machine Details Row -->
            <div style="display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.75rem; color: var(--dark-gray); padding-left: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="opacity: 0.8;">üåê</span>
                    <span style="font-family: 'Courier New', monospace;">{{ machine.ip }}</span>
                    <span style="opacity: 0.6;">|</span>
                    <span style="opacity: 0.8;">{{ machine.name }}</span>
                </div>
            </div>
        </div>
        
        <!-- Latest Data Section -->
        <div class="machine-data-section" data-machine-id="{{ machine.machine_id }}">
        {% if machine.latest_record %}
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--light-gray);">
            <!-- Model Name Display (NEW) -->
            {% if machine.latest_record.model_name and machine.latest_record.model_name != 'N/A' %}
            <div style="margin-bottom: 0.75rem; padding: 0.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 6px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span style="color: white; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">üè∑Ô∏è Model</span>
                    <span style="color: white; font-size: 0.85rem; font-weight: 700;">{{ machine.latest_record.model_name }}</span>
                </div>
            </div>
            {% endif %}
            
            <!-- Assembly Model Names (NEW) -->
            {% if machine.is_assembly %}
                {% if machine.latest_record.model_name_internal and machine.latest_record.model_name_internal != 'N/A' %}
                <div style="margin-bottom: 0.5rem; padding: 0.4rem 0.6rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 0.65rem; font-weight: 600;">Internal Model:</span>
                        <span style="color: white; font-size: 0.75rem; font-weight: 700;">{{ machine.latest_record.model_name_internal }}</span>
                    </div>
                </div>
                {% endif %}
                {% if machine.latest_record.model_name_external and machine.latest_record.model_name_external != 'N/A' %}
                <div style="margin-bottom: 0.5rem; padding: 0.4rem 0.6rem; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 0.65rem; font-weight: 600;">External Model:</span>
                        <span style="color: white; font-size: 0.75rem; font-weight: 700;">{{ machine.latest_record.model_name_external }}</span>
                    </div>
                </div>
                {% endif %}
                {% if machine.latest_record.model_name_housing and machine.latest_record.model_name_housing != 'N/A' %}
                <div style="margin-bottom: 0.75rem; padding: 0.4rem 0.6rem; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 0.65rem; font-weight: 600;">Housing Model:</span>
                        <span style="color: white; font-size: 0.75rem; font-weight: 700;">{{ machine.latest_record.model_name_housing }}</span>
                    </div>
                </div>
                {% endif %}
            {% endif %}
            
            <!-- Painting Model Names (NEW) -->
            {% if 'Painting' in machine.name %}
                {% if machine.latest_record.model_name_housing and machine.latest_record.model_name_housing != 'N/A' %}
                <div style="margin-bottom: 0.5rem; padding: 0.4rem 0.6rem; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 0.65rem; font-weight: 600;">Housing Model:</span>
                        <span style="color: white; font-size: 0.75rem; font-weight: 700;">{{ machine.latest_record.model_name_housing }}</span>
                    </div>
                </div>
                {% endif %}
                {% if machine.latest_record.model_name_piston and machine.latest_record.model_name_piston != 'N/A' %}
                <div style="margin-bottom: 0.75rem; padding: 0.4rem 0.6rem; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 0.65rem; font-weight: 600;">Piston Model:</span>
                        <span style="color: white; font-size: 0.75rem; font-weight: 700;">{{ machine.latest_record.model_name_piston }}</span>
                    </div>
                </div>
                {% endif %}
            {% endif %}
            
            <!-- Lubrication Model Names (NEW) -->
            {% if 'Lubrication' in machine.name %}
                {% if machine.latest_record.model_name_piston and machine.latest_record.model_name_piston != 'N/A' %}
                <div style="margin-bottom: 0.5rem; padding: 0.4rem 0.6rem; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 0.65rem; font-weight: 600;">Piston Model:</span>
                        <span style="color: white; font-size: 0.75rem; font-weight: 700;">{{ machine.latest_record.model_name_piston }}</span>
                    </div>
                </div>
                {% endif %}
                {% if machine.latest_record.model_name_housing and machine.latest_record.model_name_housing != 'N/A' %}
                <div style="margin-bottom: 0.75rem; padding: 0.4rem 0.6rem; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 0.65rem; font-weight: 600;">Housing Model:</span>
                        <span style="color: white; font-size: 0.75rem; font-weight: 700;">{{ machine.latest_record.model_name_housing }}</span>
                    </div>
                </div>
                {% endif %}
            {% endif %}
            
            <!-- OP80 Model Names (NEW) -->
            {% if 'Oring_leak' in machine.name %}
                {% if machine.latest_record.model_name_internal and machine.latest_record.model_name_internal != 'N/A' %}
                <div style="margin-bottom: 0.5rem; padding: 0.4rem 0.6rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 0.65rem; font-weight: 600;">Internal Model:</span>
                        <span style="color: white; font-size: 0.75rem; font-weight: 700;">{{ machine.latest_record.model_name_internal }}</span>
                    </div>
                </div>
                {% endif %}
                {% if machine.latest_record.model_name_external and machine.latest_record.model_name_external != 'N/A' %}
                <div style="margin-bottom: 0.75rem; padding: 0.4rem 0.6rem; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 0.65rem; font-weight: 600;">External Model:</span>
                        <span style="color: white; font-size: 0.75rem; font-weight: 700;">{{ machine.latest_record.model_name_external }}</span>
                    </div>
                </div>
                {% endif %}
            {% endif %}
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--dark-gray); font-size: 0.85rem;">
                    {% if 'Painting' in machine.name %}QR Housing:
                    {% elif 'Lubrication' in machine.name %}QR Piston:
                    {% elif 'Oring_leak' in machine.name %}QR Piston:
                    {% else %}Latest QR:{% endif %}
                </span>
                <strong style="font-size: 0.85rem;">{{ machine.latest_record.qr_code }}</strong>
            </div>
            
            {% if 'Painting' in machine.name and machine.latest_record.qr_piston %}
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--dark-gray); font-size: 0.85rem;">QR Piston:</span>
                <span style="font-size: 0.85rem;">{{ machine.latest_record.qr_piston }}</span>
            </div>
            {% endif %}
            
            {% if 'Lubrication' in machine.name and machine.latest_record.qr_housing %}
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--dark-gray); font-size: 0.85rem;">QR Housing:</span>
                <span style="font-size: 0.85rem;">{{ machine.latest_record.qr_housing }}</span>
            </div>
            {% endif %}
            
            {% if 'Oring_leak' in machine.name and machine.latest_record.qr_housing %}
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--dark-gray); font-size: 0.85rem;">QR Housing:</span>
                <span style="font-size: 0.85rem;">{{ machine.latest_record.qr_housing }}</span>
            </div>
            {% endif %}
            
            <div style="display: flex; flex-direction: column; gap: 0.25rem; margin-bottom: 0.5rem;">
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--dark-gray); font-size: 0.85rem;">Date:</span>
                    <span style="font-size: 0.85rem;" data-timestamp-date="{{ machine.latest_record.prep_timestamp }}"></span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--dark-gray); font-size: 0.85rem;">Time:</span>
                    <span style="font-size: 0.85rem;" data-timestamp-time="{{ machine.latest_record.prep_timestamp }}"></span>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--dark-gray); font-size: 0.85rem;">Status:</span>
                {% if machine.latest_record.post_status == "OK" %}
                    <span class="status-badge status-ok" style="font-size: 0.8rem;">‚úÖ OK</span>
                {% elif machine.latest_record.post_status == "NG" %}
                    <span class="status-badge status-ng" style="font-size: 0.8rem;">‚ùå NG</span>
                {% else %}
                    <span class="status-badge status-inprogress" style="font-size: 0.8rem;">‚è≥ Pending</span>
                {% endif %}
            </div>
            
            {% if machine.latest_record.gauge_values %}
            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f0f0f0;">
                <div style="color: var(--dark-gray); font-size: 0.8rem; margin-bottom: 0.5rem;">Gauge Values:</div>
                {% for key, value in machine.latest_record.gauge_values.items %}
                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                    <span>{{ key }}:</span>
                    <span style="font-weight: 600;">{{ value|floatformat:3 }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if machine.is_assembly and machine.latest_record.qr_external != '-' %}
            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f0f0f0; font-size: 0.75rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span style="color: var(--dark-gray);">External:</span>
                    <span>{{ machine.latest_record.qr_external }}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--dark-gray);">Housing:</span>
                    <span>{{ machine.latest_record.qr_housing }}</span>
                </div>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div style="margin-top: 1rem; color: var(--dark-gray); font-style: italic; text-align: center;">
            No data available
        </div>
        {% endif %}
        </div>
        
        <!-- Status Section -->
        <div class="machine-status-section" data-machine-id="{{ machine.machine_id }}" style="margin-top: 1rem; font-size: 0.9rem;">
            {% if machine.is_active %}
                <span style="color: var(--success-green); font-weight: 600;">‚óè ACTIVE</span>
            {% else %}
                <span style="color: var(--danger-red); font-weight: 600;">‚óè INACTIVE</span>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Fullscreen Machine Detail Modal -->
<div id="machineModal" class="modal">
    <div class="modal-content" style="max-width: 100%; width: 95%; height:97%">
        <span class="modal-close" onclick="closeMachineModal()">&times;</span>
        <h2 id="machineModalTitle">
            Machine Details
            <span id="modalConnectionStatus" style="font-size: 0.8rem; margin-left: 1rem;">
                <span class="status-indicator status-active"></span> Live
            </span>
        </h2>
        
        <div class="modal-body">
            <div id="machineModalContent">
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 2rem;">‚è≥</div>
                    <p>Loading machine data...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Group Button Styles */
.machine-groups-container {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.group-button {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 1.5rem;
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 120px;
}

.group-button:hover {
    border-color: var(--primary-blue);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,102,204,0.2);
}

.group-button.active {
    background: var(--primary-blue);
    border-color: var(--primary-blue);
    color: white;
}

.group-button.active .group-count {
    background: white;
    color: var(--primary-blue);
}

.group-icon {
    font-size: 1.5rem;
}

.group-name {
    font-size: 0.85rem;
    font-weight: 600;
    text-align: center;
}

.group-count {
    background: var(--light-gray);
    color: var(--dark-blue);
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 700;
}

/* Machine card hidden state for filtering */
.machine-grid-card.hidden {
    display: none !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .machine-groups-header {
        justify-content: center;
    }
    
    .group-button {
        min-width: 100px;
        padding: 0.75rem 1rem;
    }
    
    .group-icon {
        font-size: 1.25rem;
    }
    
    .group-name {
        font-size: 0.75rem;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
let currentMachineId = null;
let currentMachineType = null;
let dashboardEventSource = null;
let machineEventSource = null;
let currentGroup = 'all';

function getMachineGroup(machineId) {
    if (machineId.includes('dmg_mori')) return 'dmg_mori';
    if (machineId.includes('gauge')) return 'gauge';
    if (machineId.includes('honing')) return 'honing';
    if (machineId.includes('prewashing') || machineId.includes('finalwashing') || machineId.includes('finlwashing')) return 'washing';
    if (machineId.includes('deburring')) return 'processing';
    if (machineId.includes('op40')) return 'assembly';
    if (machineId.includes('op80') || machineId.includes('painting') || machineId.includes('lubrication')) return 'special';
    return 'other';
}

function filterMachineGroup(group) {
    currentGroup = group;
    
    document.querySelectorAll('.group-button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-group="${group}"]`).classList.add('active');
    
    const allCards = document.querySelectorAll('.machine-grid-card');
    
    allCards.forEach(card => {
        const cardGroup = card.getAttribute('data-machine-group');
        
        if (group === 'all' || cardGroup === group) {
            card.classList.remove('hidden');
        } else {
            card.classList.add('hidden');
        }
    });
}

function updateGroupCounts() {
    const groups = {
        all: 0,
        dmg_mori: 0,
        gauge: 0,
        honing: 0,
        washing: 0,
        processing: 0,
        assembly: 0,
        special: 0
    };
    
    document.querySelectorAll('.machine-grid-card').forEach(card => {
        const group = card.getAttribute('data-machine-group');
        groups.all++;
        if (groups[group] !== undefined) {
            groups[group]++;
        }
    });
    
    Object.keys(groups).forEach(group => {
        const countEl = document.getElementById(`count-${group}`);
        if (countEl) {
            countEl.textContent = groups[group];
        }
    });
}

function parseCustomTimestamp(timestamp) {
    if (!timestamp) return null;
    
    try {
        if (timestamp instanceof Date) return timestamp;
        
        if (timestamp.includes('T') || (timestamp.includes('-') && !timestamp.includes(','))) {
            const date = new Date(timestamp);
            if (!isNaN(date.getTime())) return date;
        }
        
        const match = timestamp.match(/(\d{1,2})\/(\d{1,2})\/(\d{4}),?\s+(\d{1,2}):(\d{2}):(\d{2})\s*(am|pm|AM|PM)/i);
        if (match) {
            let [, day, month, year, hour, minute, second, meridiem] = match;
            
            day = parseInt(day);
            month = parseInt(month);
            year = parseInt(year);
            hour = parseInt(hour);
            minute = parseInt(minute);
            second = parseInt(second);
            
            if (meridiem.toLowerCase() === 'pm' && hour !== 12) {
                hour += 12;
            } else if (meridiem.toLowerCase() === 'am' && hour === 12) {
                hour = 0;
            }
            
            let date = new Date(year, month - 1, day, hour, minute, second);
            if (!isNaN(date.getTime()) && date.getDate() === day) {
                return date;
            }
            
            date = new Date(year, day - 1, month, hour, minute, second);
            if (!isNaN(date.getTime())) {
                return date;
            }
        }
        
        const date = new Date(timestamp);
        if (!isNaN(date.getTime())) return date;
        
        return null;
    } catch (e) {
        console.error('Error parsing timestamp:', e, timestamp);
        return null;
    }
}

function formatDate(timestamp) {
    if (!timestamp) return '-';
    const date = parseCustomTimestamp(timestamp);
    if (!date) return timestamp;
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
    });
}

function formatTime(timestamp) {
    if (!timestamp) return '-';
    const date = parseCustomTimestamp(timestamp);
    if (!date) return timestamp;
    return date.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
    });
}

function formatDateTime(timestamp) {
    if (!timestamp) return '-';
    const date = parseCustomTimestamp(timestamp);
    if (!date) return timestamp;
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
    }) + ', ' + date.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
    });
}

function formatAllTimestamps() {
    document.querySelectorAll('[data-timestamp-date]').forEach(element => {
        const timestamp = element.getAttribute('data-timestamp-date');
        element.textContent = formatDate(timestamp);
    });
    
    document.querySelectorAll('[data-timestamp-time]').forEach(element => {
        const timestamp = element.getAttribute('data-timestamp-time');
        element.textContent = formatTime(timestamp);
    });
    
    document.querySelectorAll('[data-timestamp-full]').forEach(element => {
        const timestamp = element.getAttribute('data-timestamp-full');
        element.textContent = formatDateTime(timestamp);
    });
}

function initDashboardStream() {
    if (dashboardEventSource) {
        dashboardEventSource.close();
    }
    
    dashboardEventSource = new EventSource('/stream/dashboard/');
    
    dashboardEventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            if (data.type === 'update' && data.machines) {
                updateDashboardMachines(data.machines);
            }
        } catch (error) {
            console.error('Error parsing dashboard update:', error);
        }
    };
    
    dashboardEventSource.onerror = function(error) {
        console.error('Dashboard stream error:', error);
        updateConnectionStatus(false);
        
        setTimeout(() => {
            console.log('Attempting to reconnect dashboard stream...');
            initDashboardStream();
        }, 5000);
    };
    
    dashboardEventSource.onopen = function() {
        console.log('Dashboard stream connected');
        updateConnectionStatus(true);
    };
}

function updateConnectionStatus(connected) {
    const statusEl = document.getElementById('connectionStatus');
    if (statusEl) {
        const indicator = statusEl.querySelector('.status-indicator');
        if (connected) {
            indicator.className = 'status-indicator status-active';
            statusEl.innerHTML = '<span class="status-indicator status-active"></span> Live';
        } else {
            indicator.className = 'status-indicator status-inactive';
            statusEl.innerHTML = '<span class="status-indicator status-inactive"></span> Reconnecting...';
        }
    }
}

function updateModalConnectionStatus(connected) {
    const statusEl = document.getElementById('modalConnectionStatus');
    if (statusEl) {
        if (connected) {
            statusEl.innerHTML = '<span class="status-indicator status-active"></span> Live';
        } else {
            statusEl.innerHTML = '<span class="status-indicator status-inactive"></span> Reconnecting...';
        }
    }
}

function getMachineName(machineId) {
    const card = document.getElementById(`machine-card-${machineId}`);
    if (card) {
        const title = card.querySelector('.machine-grid-title');
        if (title) {
            return title.textContent.trim();
        }
    }
    return '';
}

// Helper function to generate model name badges HTML
function generateModelBadges(machine) {
    let badgesHTML = '';
    
    // Standard machines - single model_name
    if (machine.latest_record.model_name && machine.latest_record.model_name !== 'N/A' && 
        !machine.is_assembly && !machine.name.includes('Painting') && 
        !machine.name.includes('Lubrication') && !machine.name.includes('Oring_leak')) {
        badgesHTML += `
            <div style="margin-bottom: 0.75rem; padding: 0.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 6px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span style="color: white; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">üè∑Ô∏è Model</span>
                    <span style="color: white; font-size: 0.85rem; font-weight: 700;">${machine.latest_record.model_name}</span>
                </div>
            </div>
        `;
    }
    
    // Assembly machines - three models
    if (machine.is_assembly) {
        if (machine.latest_record.model_name_internal && machine.latest_record.model_name_internal !== 'N/A') {
            badgesHTML += `
                <div style="margin-bottom: 0.5rem; padding: 0.4rem 0.6rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 0.65rem; font-weight: 600;">Internal Model:</span>
                        <span style="color: white; font-size: 0.75rem; font-weight: 700;">${machine.latest_record.model_name_internal}</span>
                    </div>
                </div>
            `;
        }
        if (machine.latest_record.model_name_external && machine.latest_record.model_name_external !== 'N/A') {
            badgesHTML += `
                <div style="margin-bottom: 0.5rem; padding: 0.4rem 0.6rem; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 0.65rem; font-weight: 600;">External Model:</span>
                        <span style="color: white; font-size: 0.75rem; font-weight: 700;">${machine.latest_record.model_name_external}</span>
                    </div>
                </div>
            `;
        }
        if (machine.latest_record.model_name_housing && machine.latest_record.model_name_housing !== 'N/A') {
            badgesHTML += `
                <div style="margin-bottom: 0.75rem; padding: 0.4rem 0.6rem; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 0.65rem; font-weight: 600;">Housing Model:</span>
                        <span style="color: white; font-size: 0.75rem; font-weight: 700;">${machine.latest_record.model_name_housing}</span>
                    </div>
                </div>
            `;
        }
    }
    
    // Painting - housing and piston models
    if (machine.name && machine.name.includes('Painting')) {
        if (machine.latest_record.model_name_housing && machine.latest_record.model_name_housing !== 'N/A') {
            badgesHTML += `
                <div style="margin-bottom: 0.5rem; padding: 0.4rem 0.6rem; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 0.65rem; font-weight: 600;">Housing Model:</span>
                        <span style="color: white; font-size: 0.75rem; font-weight: 700;">${machine.latest_record.model_name_housing}</span>
                    </div>
                </div>
            `;
        }
        if (machine.latest_record.model_name_piston && machine.latest_record.model_name_piston !== 'N/A') {
            badgesHTML += `
                <div style="margin-bottom: 0.75rem; padding: 0.4rem 0.6rem; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 0.65rem; font-weight: 600;">Piston Model:</span>
                        <span style="color: white; font-size: 0.75rem; font-weight: 700;">${machine.latest_record.model_name_piston}</span>
                    </div>
                </div>
            `;
        }
    }
    
    // Lubrication - piston and housing models
    if (machine.name && machine.name.includes('Lubrication')) {
        if (machine.latest_record.model_name_piston && machine.latest_record.model_name_piston !== 'N/A') {
            badgesHTML += `
                <div style="margin-bottom: 0.5rem; padding: 0.4rem 0.6rem; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 0.65rem; font-weight: 600;">Piston Model:</span>
                        <span style="color: white; font-size: 0.75rem; font-weight: 700;">${machine.latest_record.model_name_piston}</span>
                    </div>
                </div>
            `;
        }
        if (machine.latest_record.model_name_housing && machine.latest_record.model_name_housing !== 'N/A') {
            badgesHTML += `
                <div style="margin-bottom: 0.75rem; padding: 0.4rem 0.6rem; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 0.65rem; font-weight: 600;">Housing Model:</span>
                        <span style="color: white; font-size: 0.75rem; font-weight: 700;">${machine.latest_record.model_name_housing}</span>
                    </div>
                </div>
            `;
        }
    }
    
    // OP80 - internal and external models
    if (machine.name && machine.name.includes('Oring_leak')) {
        if (machine.latest_record.model_name_internal && machine.latest_record.model_name_internal !== 'N/A') {
            badgesHTML += `
                <div style="margin-bottom: 0.5rem; padding: 0.4rem 0.6rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 0.65rem; font-weight: 600;">Internal Model:</span>
                        <span style="color: white; font-size: 0.75rem; font-weight: 700;">${machine.latest_record.model_name_internal}</span>
                    </div>
                </div>
            `;
        }
        if (machine.latest_record.model_name_external && machine.latest_record.model_name_external !== 'N/A') {
            badgesHTML += `
                <div style="margin-bottom: 0.75rem; padding: 0.4rem 0.6rem; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 0.65rem; font-weight: 600;">External Model:</span>
                        <span style="color: white; font-size: 0.75rem; font-weight: 700;">${machine.latest_record.model_name_external}</span>
                    </div>
                </div>
            `;
        }
    }
    
    return badgesHTML;
}

function updateDashboardMachines(machines) {
    machines.forEach(machine => {
        const card = document.getElementById(`machine-card-${machine.machine_id}`);
        if (!card) return;
        
        const machineName = machine.display_name || getMachineName(machine.machine_id);
        
        card.style.transition = 'box-shadow 0.3s ease';
        card.style.boxShadow = '0 0 15px rgba(0, 102, 204, 0.3)';
        setTimeout(() => {
            card.style.boxShadow = '';
        }, 1000);
        
        const machineHeader = card.querySelector('.machine-grid-header');
        const statusIndicator = machineHeader.querySelector('.status-indicator');
        
        if (statusIndicator && machine.is_active !== undefined) {
            statusIndicator.className = machine.is_active ? 
                'status-indicator status-active' : 
                'status-indicator status-inactive';
        }
        
        const dataSection = card.querySelector(`.machine-data-section[data-machine-id="${machine.machine_id}"]`);
        const activeStatusSection = card.querySelector(`.machine-status-section[data-machine-id="${machine.machine_id}"]`);
        
        // Washing machines with Load/Unload
        if (machine.type === 'washing' && machine.latest_record && dataSection) {
            const isLoad = machine.latest_record.prep_status === 'LOAD';
            const isUnload = machine.latest_record.prep_status === 'UNLOAD';
            
            let operationLabel = 'Latest QR:';
            let operationIcon = '';
            let operationBadge = '';
            
            if (isLoad) {
                operationLabel = 'üì• Loaded:';
                operationIcon = '<div style="font-size: 0.7rem; color: #1565c0; font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">Load Operation</div>';
                operationBadge = '<span class="status-badge" style="font-size: 0.75rem; background: #e3f2fd; color: #1565c0;">üì• LOADED</span>';
            } else if (isUnload) {
                operationLabel = 'üì§ Unloaded:';
                operationIcon = '<div style="font-size: 0.7rem; color: #e65100; font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">Unload Operation</div>';
                operationBadge = '<span class="status-badge" style="font-size: 0.75rem; background: #fff3e0; color: #e65100;">üì§ UNLOADED</span>';
            }
            
            // Add model name badge for washing machines
            let modelBadgeHTML = '';
            if (machine.latest_record.model_name && machine.latest_record.model_name !== 'N/A') {
                modelBadgeHTML = `
                    <div style="margin-bottom: 0.75rem; padding: 0.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 6px;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span style="color: white; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">üè∑Ô∏è Model</span>
                            <span style="color: white; font-size: 0.85rem; font-weight: 700;">${machine.latest_record.model_name}</span>
                        </div>
                    </div>
                `;
            }
            
            let recordHTML = `
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--light-gray);">
                    ${operationIcon}
                    ${modelBadgeHTML}
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: var(--dark-gray); font-size: 0.85rem;">${operationLabel}</span>
                        <strong style="font-size: 0.85rem;">${machine.latest_record.qr_code}</strong>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.25rem; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--dark-gray); font-size: 0.85rem;">Date:</span>
                            <span style="font-size: 0.85rem;">${formatDate(machine.latest_record.prep_timestamp)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--dark-gray); font-size: 0.85rem;">Time:</span>
                            <span style="font-size: 0.85rem;">${formatTime(machine.latest_record.prep_timestamp)}</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--dark-gray); font-size: 0.85rem;">Status:</span>
                        ${machine.latest_record.post_status === 'OK' || machine.latest_record.prep_status === 'OK' ? 
                            '<span class="status-badge status-ok" style="font-size: 0.8rem;">‚úÖ OK</span>' :
                            machine.latest_record.post_status === 'NG' ? 
                            '<span class="status-badge status-ng" style="font-size: 0.8rem;">‚ùå NG</span>' :
                            operationBadge
                        }
                    </div>
                </div>
            `;
            
            dataSection.innerHTML = recordHTML;
            
            if (activeStatusSection) {
                if (machine.is_active) {
                    activeStatusSection.innerHTML = '<span style="color: var(--success-green); font-weight: 600;">‚óè ACTIVE</span>';
                } else {
                    activeStatusSection.innerHTML = '<span style="color: var(--danger-red); font-weight: 600;">‚óè INACTIVE</span>';
                }
            }
            
            return;
        }
        
        // Regular machine card update
        if (dataSection) {
            if (machine.latest_record) {
                let qrLabel = 'Latest QR:';
                if (machine.name && machine.name.includes('Painting')) qrLabel = 'QR Housing:';
                else if (machine.name && machine.name.includes('Lubrication')) qrLabel = 'QR Piston:';
                else if (machine.name && machine.name.includes('Oring_leak')) qrLabel = 'QR Piston:';
                
                // Generate model badges
                const modelBadges = generateModelBadges(machine);
                
                let recordHTML = `
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--light-gray);">
                        ${modelBadges}
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--dark-gray); font-size: 0.85rem;">${qrLabel}</span>
                            <strong style="font-size: 0.85rem;">${machine.latest_record.qr_code}</strong>
                        </div>
                `;
                
                if (machine.name && machine.name.includes('Painting') && machine.latest_record.qr_piston) {
                    recordHTML += `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--dark-gray); font-size: 0.85rem;">QR Piston:</span>
                            <span style="font-size: 0.85rem;">${machine.latest_record.qr_piston}</span>
                        </div>
                    `;
                }
                
                if (machine.name && machine.name.includes('Lubrication') && machine.latest_record.qr_housing) {
                    recordHTML += `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--dark-gray); font-size: 0.85rem;">QR Housing:</span>
                            <span style="font-size: 0.85rem;">${machine.latest_record.qr_housing}</span>
                        </div>
                    `;
                }
                
                if (machine.name && machine.name.includes('Oring_leak') && machine.latest_record.qr_housing) {
                    recordHTML += `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--dark-gray); font-size: 0.85rem;">QR Housing:</span>
                            <span style="font-size: 0.85rem;">${machine.latest_record.qr_housing}</span>
                        </div>
                    `;
                }
                
                recordHTML += `
                        <div style="display: flex; flex-direction: column; gap: 0.25rem; margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--dark-gray); font-size: 0.85rem;">Date:</span>
                                <span style="font-size: 0.85rem;">${formatDate(machine.latest_record.prep_timestamp)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--dark-gray); font-size: 0.85rem;">Time:</span>
                                <span style="font-size: 0.85rem;">${formatTime(machine.latest_record.prep_timestamp)}</span>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--dark-gray); font-size: 0.85rem;">Status:</span>
                `;
                
                if (machine.latest_record.post_status === 'OK') {
                    recordHTML += '<span class="status-badge status-ok" style="font-size: 0.8rem;">‚úÖ OK</span>';
                } else if (machine.latest_record.post_status === 'NG') {
                    recordHTML += '<span class="status-badge status-ng" style="font-size: 0.8rem;">‚ùå NG</span>';
                } else {
                    recordHTML += '<span class="status-badge status-inprogress" style="font-size: 0.8rem;">‚è≥ Pending</span>';
                }
                recordHTML += '</div>';
                
                if (machine.latest_record.gauge_values && Object.keys(machine.latest_record.gauge_values).length > 0) {
                    recordHTML += `
                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f0f0f0;">
                            <div style="color: var(--dark-gray); font-size: 0.8rem; margin-bottom: 0.5rem;">Gauge Values:</div>
                    `;
                    for (const [key, value] of Object.entries(machine.latest_record.gauge_values)) {
                        recordHTML += `
                            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                                <span>${key}:</span>
                                <span style="font-weight: 600;">${parseFloat(value).toFixed(3)}</span>
                            </div>
                        `;
                    }
                    recordHTML += '</div>';
                }
                
                if (machine.is_assembly && machine.latest_record.qr_external && machine.latest_record.qr_external !== '-') {
                    recordHTML += `
                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f0f0f0; font-size: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span style="color: var(--dark-gray);">External:</span>
                                <span>${machine.latest_record.qr_external}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--dark-gray);">Housing:</span>
                                <span>${machine.latest_record.qr_housing}</span>
                            </div>
                        </div>
                    `;
                }
                
                recordHTML += '</div>';
                dataSection.innerHTML = recordHTML;
            } else {
                dataSection.innerHTML = '<div style="margin-top: 1rem; color: var(--dark-gray); font-style: italic; text-align: center;">No data available</div>';
            }
        }
        
        if (activeStatusSection) {
            if (machine.is_active) {
                activeStatusSection.innerHTML = '<span style="color: var(--success-green); font-weight: 600;">‚óè ACTIVE</span>';
            } else {
                activeStatusSection.innerHTML = '<span style="color: var(--danger-red); font-weight: 600;">‚óè INACTIVE</span>';
            }
        }
    });
}

function initMachineStream(machineId) {
    if (machineEventSource) {
        machineEventSource.close();
    }
    
    machineEventSource = new EventSource(`/stream/machine/${machineId}/`);
    
    machineEventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            if (data.type === 'update') {
                currentMachineType = data.machine_type || 'standard';
                renderMachineData(data);
                
                const content = document.getElementById('machineModalContent');
                if (content) {
                    content.style.transition = 'opacity 0.2s ease';
                    content.style.opacity = '0.7';
                    setTimeout(() => {
                        content.style.opacity = '1';
                    }, 200);
                }
            }
        } catch (error) {
            console.error('Error parsing machine update:', error);
        }
    };
    
    machineEventSource.onerror = function(error) {
        console.error('Machine stream error:', error);
        updateModalConnectionStatus(false);
        
        setTimeout(() => {
            if (currentMachineId === machineId) {
                console.log('Attempting to reconnect machine stream...');
                initMachineStream(machineId);
            }
        }, 5000);
    };
    
    machineEventSource.onopen = function() {
        console.log('Machine stream connected');
        updateModalConnectionStatus(true);
    };
}

function openMachineModal(machineId, machineName) {
    currentMachineId = machineId;
    document.getElementById('machineModalTitle').innerHTML = `
        ${machineName}
        <span id="modalConnectionStatus" style="font-size: 0.8rem; margin-left: 1rem;">
            <span class="status-indicator status-active"></span> Connecting...
        </span>
    `;
    document.getElementById('machineModal').style.display = 'flex';
    
    fetch(`/api/machine/${machineId}/`)
        .then(response => response.json())
        .then(data => {
            currentMachineType = data.machine_type || 'standard';
            renderMachineData(data);
            initMachineStream(machineId);
        })
        .catch(error => {
            document.getElementById('machineModalContent').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--danger-red);">
                    <div style="font-size: 2rem;">‚ö†Ô∏è</div>
                    <p>Error loading machine data</p>
                </div>
            `;
        });
}

function closeMachineModal() {
    document.getElementById('machineModal').style.display = 'none';
    currentMachineId = null;
    currentMachineType = null;
    
    if (machineEventSource) {
        machineEventSource.close();
        machineEventSource = null;
    }
}

// Washing machine modal rendering
function renderWashingMachineData(data, operation) {
    const content = document.getElementById('machineModalContent');
    const isLoad = operation === 'load';
    
    let tableHTML = `
        <div style="margin-bottom: 1.5rem; padding: 1.5rem; background: ${isLoad ? '#e3f2fd' : '#fff3e0'}; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 0.5rem 0; color: var(--dark-blue); display: flex; align-items: center; gap: 0.5rem;">
                ${isLoad ? 'üì• LOAD Operation' : 'üì§ UNLOAD Operation'}
            </h3>
            <p style="margin: 0; color: var(--dark-gray); font-size: 0.95rem;">
                ${isLoad ? 
                    'Parts entering the washing machine (Preprocessing data)' : 
                    'Parts exiting the washing machine (Postprocessing data)'}
            </p>
        </div>
        
        <div class="data-table-container" style="max-height: 75vh; overflow-y: auto;">
            <table class="data-table" style="width: 100%; border-collapse: collapse;">
                <thead style="position: sticky; top: 0; z-index: 10; background: white;">
                    <tr>
                        <th colspan="4" style="background: ${isLoad ? 'rgba(25, 118, 210, 0.1)' : 'rgba(255, 152, 0, 0.1)'}; text-align: center; padding: 12px; border: 1px solid #ddd; font-size: 1rem;">
                            ${isLoad ? 'üì• Load Details' : 'üì§ Unload Details'}
                        </th>
                        <th colspan="2" style="background: rgba(200, 200, 200, 0.3); text-align: center; padding: 12px; border: 1px solid #ddd; font-size: 1rem;">
                            Part Information
                        </th>
                    </tr>
                    <tr>
                        <th style="background: rgba(240, 240, 240, 0.95); padding: 10px; border: 1px solid #ddd; font-size: 0.9rem; font-weight: 600;">ID</th>
                        <th style="background: rgba(240, 240, 240, 0.95); padding: 10px; border: 1px solid #ddd; font-size: 0.9rem; font-weight: 600;">Date</th>
                        <th style="background: rgba(240, 240, 240, 0.95); padding: 10px; border: 1px solid #ddd; font-size: 0.9rem; font-weight: 600;">Time</th>
                        <th style="background: rgba(240, 240, 240, 0.95); padding: 10px; border: 1px solid #ddd; font-size: 0.9rem; font-weight: 600;">Status</th>
                        <th style="background: rgba(240, 240, 240, 0.95); padding: 10px; border: 1px solid #ddd; font-size: 0.9rem; font-weight: 600;">QR Code</th>
                        <th style="background: rgba(240, 240, 240, 0.95); padding: 10px; border: 1px solid #ddd; font-size: 0.9rem; font-weight: 600;">üè∑Ô∏è Model</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    if (!data.records || data.records.length === 0) {
        tableHTML += `
            <tr>
                <td colspan="6" style="padding: 3rem; text-align: center; color: var(--dark-gray);">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">üìä</div>
                    <p style="font-size: 1.1rem; margin: 0;">No data available</p>
                    <p style="font-size: 0.9rem; margin: 0.5rem 0 0 0; opacity: 0.7;">
                        Waiting for ${isLoad ? 'load' : 'unload'} operations...
                    </p>
                </td>
            </tr>
        `;
    } else {
        data.records.forEach(record => {
            const timestamp = record.prep_timestamp || record.post_timestamp;
            const recDate = formatDate(timestamp);
            const recTime = formatTime(timestamp);
            const recordId = isLoad ? record.prep_id : record.post_id;
            const status = isLoad ? record.prep_status : record.post_status;
            const qrCode = record.qr_code || '-';
            const modelName = record.model_name || 'N/A';
            
            let statusBadge = '';
            if (status === 'OK') {
                statusBadge = '<span class="status-badge status-ok">‚úÖ OK</span>';
            } else if (status === 'NG') {
                statusBadge = '<span class="status-badge status-ng">‚ùå NG</span>';
            } else if (status === 'LOAD' || status === 'N/A' && isLoad) {
                statusBadge = '<span class="status-badge" style="background: #e3f2fd; color: #1565c0; font-weight: 600;">üì• LOADED</span>';
            } else if (status === 'UNLOAD' || status === 'N/A' && !isLoad) {
                statusBadge = '<span class="status-badge" style="background: #fff3e0; color: #e65100; font-weight: 600;">üì§ UNLOADED</span>';
            } else {
                statusBadge = `<span class="status-badge status-inprogress">${status}</span>`;
            }
            
            tableHTML += `
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 500;">${recordId || '-'}</td>
                    <td style="padding: 12px; border: 1px solid #ddd;"><small>${recDate}</small></td>
                    <td style="padding: 12px; border: 1px solid #ddd;"><small>${recTime}</small></td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${statusBadge}</td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: center;"><strong style="font-family: 'Courier New', monospace;">${qrCode}</strong></td>
                    <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                        <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 700;">${modelName}</span>
                    </td>
                </tr>
            `;
        });
    }
    
    tableHTML += `
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-left: 4px solid ${isLoad ? '#1976d2' : '#f57c00'}; border-radius: 4px;">
            <p style="margin: 0; font-size: 0.9rem; color: var(--dark-gray); line-height: 1.6;">
                <strong style="color: var(--dark-blue);">Note:</strong> 
                ${isLoad ? 
                    'Load operation records when parts <strong>enter</strong> the washing machine. This shows <strong>preprocessing data only</strong> ‚Äî no postprocessing status is tracked at this stage.' :
                    'Unload operation records when parts <strong>exit</strong> the washing machine. This shows <strong>postprocessing data only</strong> ‚Äî no preprocessing data is tracked at this stage.'
                }
            </p>
        </div>
    `;
    
    content.innerHTML = tableHTML;
}

// Main render function with washing machine support
function renderMachineData(data) {
    const content = document.getElementById('machineModalContent');
    
    if (!data.records || data.records.length === 0) {
        content.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
                <div style="font-size: 2rem;">üìä</div>
                <h3>No data available</h3>
                <p>Waiting for production data...</p>
            </div>
        `;
        return;
    }
    
    const machineType = data.machine_type || currentMachineType || 'standard';
    const operation = data.operation;
    
    // Handle washing machines separately
    if (machineType === 'washing') {
        renderWashingMachineData(data, operation);
        return;
    }
    
    // Rest of modal rendering for other machines (continues with existing code...)
    // (Your existing renderMachineData code for CNC, Gauge, Assembly, Painting, etc.)
    // I'll continue with the table rendering code that was in your original file
    
    let isPainting = machineType === 'painting';
    let isOP80 = machineType === 'op80';
    let isLubrication = machineType === 'lubrication';
    let isAssembly = machineType === 'assembly';
    
    let tableHTML = `
        <div class="data-table-container" style="max-height: 90vh; overflow-y: auto;">
            <table class="data-table" style="width: 100%; border-collapse: collapse;">
                <thead style="position: sticky; top: 0; z-index: 10; background: white;">
                    <tr>
                        <th colspan="4" style="background: rgba(0, 102, 204, 0.1); text-align: center; padding: 8px; border: 1px solid #ddd;">Preprocessing</th>
    `;
    
    // QR Code columns header
    if (isAssembly) {
        tableHTML += `<th colspan="3" style="background: rgba(200, 200, 200, 0.3); text-align: center; padding: 8px; border: 1px solid #ddd;">QR Codes</th>`;
    } else if (isPainting || isLubrication || isOP80) {
        tableHTML += `<th colspan="2" style="background: rgba(200, 200, 200, 0.3); text-align: center; padding: 8px; border: 1px solid #ddd;">QR Codes</th>`;
    } else {
        tableHTML += `<th style="background: rgba(200, 200, 200, 0.3); text-align: center; padding: 8px; border: 1px solid #ddd;">QR Code</th>`;
    }
    
    // Add Model column header
    if (isAssembly) {
        tableHTML += `<th colspan="3" style="background: rgba(102, 126, 234, 0.15); text-align: center; padding: 8px; border: 1px solid #ddd;">üè∑Ô∏è Models</th>`;
    } else if (isPainting || isLubrication) {
        tableHTML += `<th colspan="2" style="background: rgba(102, 126, 234, 0.15); text-align: center; padding: 8px; border: 1px solid #ddd;">üè∑Ô∏è Models</th>`;
    } else if (isOP80) {
        tableHTML += `<th colspan="2" style="background: rgba(102, 126, 234, 0.15); text-align: center; padding: 8px; border: 1px solid #ddd;">üè∑Ô∏è Models</th>`;
    } else {
        tableHTML += `<th style="background: rgba(102, 126, 234, 0.15); text-align: center; padding: 8px; border: 1px solid #ddd;">üè∑Ô∏è Model</th>`;
    }
    
    // Postprocessing columns header
    if (isOP80) {
        tableHTML += `<th colspan="5" style="background: rgba(0, 168, 204, 0.1); text-align: center; padding: 8px; border: 1px solid #ddd;">Postprocessing</th>`;
    } else {
        tableHTML += `<th colspan="4" style="background: rgba(0, 168, 204, 0.1); text-align: center; padding: 8px; border: 1px solid #ddd;">Postprocessing</th>`;
    }
    
    tableHTML += `
                    </tr>
                    <tr>
                        <th style="background: rgba(0, 102, 204, 0.05); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">ID</th>
                        <th style="background: rgba(0, 102, 204, 0.05); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Date</th>
                        <th style="background: rgba(0, 102, 204, 0.05); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Time</th>
                        <th style="background: rgba(0, 102, 204, 0.05); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Status</th>
    `;
    
    // QR Code column headers
    if (isAssembly) {
        tableHTML += `
            <th style="background: rgba(200, 200, 200, 0.2); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Internal</th>
            <th style="background: rgba(200, 200, 200, 0.2); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">External</th>
            <th style="background: rgba(200, 200, 200, 0.2); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Housing</th>
        `;
    } else if (isPainting) {
        tableHTML += `
            <th style="background: rgba(200, 200, 200, 0.2); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Housing</th>
            <th style="background: rgba(200, 200, 200, 0.2); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Piston</th>
        `;
    } else if (isLubrication) {
        tableHTML += `
            <th style="background: rgba(200, 200, 200, 0.2); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Piston</th>
            <th style="background: rgba(200, 200, 200, 0.2); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Housing</th>
        `;
    } else if (isOP80) {
        tableHTML += `
            <th style="background: rgba(200, 200, 200, 0.2); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Piston</th>
            <th style="background: rgba(200, 200, 200, 0.2); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Housing</th>
        `;
    } else {
        tableHTML += `<th style="background: rgba(200, 200, 200, 0.2); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">QR Code</th>`;
    }
    
    // Model column headers
    if (isAssembly) {
        tableHTML += `
            <th style="background: rgba(102, 126, 234, 0.1); padding: 6px; border: 1px solid #ddd; font-size: 0.85rem;">Internal</th>
            <th style="background: rgba(102, 126, 234, 0.1); padding: 6px; border: 1px solid #ddd; font-size: 0.85rem;">External</th>
            <th style="background: rgba(102, 126, 234, 0.1); padding: 6px; border: 1px solid #ddd; font-size: 0.85rem;">Housing</th>
        `;
    } else if (isPainting) {
        tableHTML += `
            <th style="background: rgba(102, 126, 234, 0.1); padding: 6px; border: 1px solid #ddd; font-size: 0.85rem;">Housing</th>
            <th style="background: rgba(102, 126, 234, 0.1); padding: 6px; border: 1px solid #ddd; font-size: 0.85rem;">Piston</th>
        `;
    } else if (isLubrication) {
        tableHTML += `
            <th style="background: rgba(102, 126, 234, 0.1); padding: 6px; border: 1px solid #ddd; font-size: 0.85rem;">Piston</th>
            <th style="background: rgba(102, 126, 234, 0.1); padding: 6px; border: 1px solid #ddd; font-size: 0.85rem;">Housing</th>
        `;
    } else if (isOP80) {
        tableHTML += `
            <th style="background: rgba(102, 126, 234, 0.1); padding: 6px; border: 1px solid #ddd; font-size: 0.85rem;">Internal</th>
            <th style="background: rgba(102, 126, 234, 0.1); padding: 6px; border: 1px solid #ddd; font-size: 0.85rem;">External</th>
        `;
    } else {
        tableHTML += `<th style="background: rgba(102, 126, 234, 0.1); padding: 6px; border: 1px solid #ddd; font-size: 0.85rem;">Model Name</th>`;
    }
    
    // Postprocessing column headers
    tableHTML += `
            <th style="background: rgba(0, 168, 204, 0.05); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">ID</th>
            <th style="background: rgba(0, 168, 204, 0.05); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Date</th>
            <th style="background: rgba(0, 168, 204, 0.05); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Time</th>
    `;
    
    if (isOP80) {
        tableHTML += `<th style="background: rgba(0, 168, 204, 0.05); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Match</th>`;
    }
    
    tableHTML += `
            <th style="background: rgba(0, 168, 204, 0.05); padding: 6px; border: 1px solid #ddd; font-size: 0.9rem;">Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Render data rows with model names
    data.records.forEach(record => {
        const prepDate = formatDate(record.prep_timestamp);
        const prepTime = formatTime(record.prep_timestamp);
        const postDate = record.post_timestamp ? formatDate(record.post_timestamp) : '-';
        const postTime = record.post_timestamp ? formatTime(record.post_timestamp) : '-';
        
        tableHTML += `
            <tr>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${record.prep_id}</td>
                <td style="padding: 8px; border: 1px solid #ddd;"><small>${prepDate}</small></td>
                <td style="padding: 8px; border: 1px solid #ddd;"><small>${prepTime}</small></td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span class="status-badge status-ok">‚úÖ ${record.prep_status || 'OK'}</span></td>
        `;
        
        // QR Code cells
        if (isAssembly) {
            tableHTML += `
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><strong>${record.qr_code || '-'}</strong></td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><strong>${record.qr_external || '-'}</strong></td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><strong>${record.qr_housing || '-'}</strong></td>
            `;
        } else if (isPainting) {
            tableHTML += `
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><strong>${record.qr_code || '-'}</strong></td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><strong>${record.qr_piston_prep || record.qr_piston || '-'}</strong></td>
            `;
        } else if (isLubrication) {
            tableHTML += `
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><strong>${record.qr_code || '-'}</strong></td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><strong>${record.qr_housing || '-'}</strong></td>
            `;
        } else if (isOP80) {
            tableHTML += `
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><strong>${record.qr_code || record.qr_piston || '-'}</strong></td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><strong>${record.qr_housing_prep || '-'}</strong></td>
            `;
        } else {
            tableHTML += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><strong>${record.qr_code || '-'}</strong></td>`;
        }
        
        // Model name cells with colored badges
        if (isAssembly) {
            tableHTML += `
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                    <span style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">${record.model_name_internal || 'N/A'}</span>
                </td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                    <span style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">${record.model_name_external || 'N/A'}</span>
                </td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                    <span style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">${record.model_name_housing || 'N/A'}</span>
                </td>
            `;
        } else if (isPainting) {
            tableHTML += `
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                    <span style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">${record.model_name_housing || 'N/A'}</span>
                </td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                    <span style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">${record.model_name_piston || 'N/A'}</span>
                </td>
            `;
        } else if (isLubrication) {
            tableHTML += `
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                    <span style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">${record.model_name_piston || 'N/A'}</span>
                </td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                    <span style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">${record.model_name_housing || 'N/A'}</span>
                </td>
            `;
        } else if (isOP80) {
            tableHTML += `
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                    <span style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">${record.model_name_internal || 'N/A'}</span>
                </td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                    <span style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">${record.model_name_external || 'N/A'}</span>
                </td>
            `;
        } else {
            tableHTML += `
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                    <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">${record.model_name || 'N/A'}</span>
                </td>
            `;
        }
        
        // Postprocessing cells
        tableHTML += `
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${record.post_id || '-'}</td>
                <td style="padding: 8px; border: 1px solid #ddd;"><small>${postDate}</small></td>
                <td style="padding: 8px; border: 1px solid #ddd;"><small>${postTime}</small></td>
        `;
        
        if (isOP80 && record.match_status) {
            const matchBadge = (record.match_status === 'TRUE' || record.match_status === 'true') ? 
                '<span class="status-badge status-ok">‚úÖ Match</span>' : 
                '<span class="status-badge status-ng">‚ùå No Match</span>';
            tableHTML += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${matchBadge}</td>`;
        }
        
        // Status cell
        let statusCell = '-';
        if (record.post_status === 'Pending' || !record.post_status) {
            statusCell = '<span class="status-badge status-inprogress">‚è≥ Pending</span>';
        } else if (record.post_status === 'OK') {
            statusCell = '<span class="status-badge status-ok">‚úÖ OK</span>';
            if (record.gauge_values && Object.keys(record.gauge_values).length > 0) {
                statusCell += '<br><small>';
                for (const [key, value] of Object.entries(record.gauge_values)) {
                    statusCell += `${key}: ${parseFloat(value).toFixed(3)}<br>`;
                }
                statusCell += '</small>';
            }
        } else if (record.post_status === 'NG') {
            statusCell = '<span class="status-badge status-ng">‚ùå NG</span>';
        }
        
        tableHTML += `
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${statusCell}</td>
            </tr>
        `;
    });
    
    tableHTML += `
                </tbody>
            </table>
        </div>
    `;
    
    content.innerHTML = tableHTML;
}

window.onclick = function(event) {
    const modal = document.getElementById('machineModal');
    if (event.target == modal) {
        closeMachineModal();
    }
}

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeMachineModal();
    }
});

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.machine-grid-card').forEach(card => {
        const machineId = card.id.replace('machine-card-', '');
        const group = getMachineGroup(machineId);
        card.setAttribute('data-machine-group', group);
    });
    
    formatAllTimestamps();
    updateGroupCounts();
    initDashboardStream();
});

window.addEventListener('beforeunload', function() {
    if (dashboardEventSource) {
        dashboardEventSource.close();
    }
    if (machineEventSource) {
        machineEventSource.close();
    }
});
</script>
{% endblock %}
{% extends 'dashboard/base.html' %}

{% block title %}Dashboard - Manufacturing Traceability{% endblock %}

{% block content %}
<h2 style="margin-bottom: 1.5rem; color: var(--dark-blue);">
    Production Line Machines
    <span id="connectionStatus" style="font-size: 0.8rem; margin-left: 1rem;">
        <span class="status-indicator status-active"></span> Live
    </span>
</h2>

<div class="machine-grid" id="machineGrid">
    {% for machine in machines %}
    <div class="machine-grid-card" id="machine-card-{{ machine.machine_id }}" onclick="openMachineModal('{{ machine.machine_id }}', '{{ machine.name }}')" style="cursor: pointer;">
        <div class="machine-grid-header">
            <div class="machine-grid-title">
                <span class="status-indicator {% if machine.is_active %}status-active{% else %}status-inactive{% endif %}"></span>
                {{ machine.name }}
            </div>
            <span class="machine-type-badge type-{{ machine.type }}">{{ machine.type|upper }}</span>
        </div>
        
        <div class="machine-data-section" data-machine-id="{{ machine.machine_id }}">
        {% if machine.latest_record %}
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--light-gray);">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--dark-gray); font-size: 0.85rem;">Latest QR:</span>
                <strong style="font-size: 0.85rem;">{{ machine.latest_record.qr_code }}</strong>
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.25rem; margin-bottom: 0.5rem;">
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--dark-gray); font-size: 0.85rem;">Date:</span>
                    <span style="font-size: 0.85rem;" data-timestamp-date="{{ machine.latest_record.prep_timestamp }}"></span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--dark-gray); font-size: 0.85rem;">Time:</span>
                    <span style="font-size: 0.85rem;" data-timestamp-time="{{ machine.latest_record.prep_timestamp }}"></span>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--dark-gray); font-size: 0.85rem;">Status:</span>
                {% if machine.latest_record.post_status == "OK" %}
                    <span class="status-badge status-ok" style="font-size: 0.8rem;">‚úÖ OK</span>
                {% elif machine.latest_record.post_status == "NG" %}
                    <span class="status-badge status-ng" style="font-size: 0.8rem;">‚ùå NG</span>
                {% else %}
                    <span class="status-badge status-inprogress" style="font-size: 0.8rem;">‚è≥ Pending</span>
                {% endif %}
            </div>
            
            {% if machine.latest_record.gauge_values %}
            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f0f0f0;">
                <div style="color: var(--dark-gray); font-size: 0.8rem; margin-bottom: 0.5rem;">Gauge Values:</div>
                {% for key, value in machine.latest_record.gauge_values.items %}
                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                    <span>{{ key }}:</span>
                    <span style="font-weight: 600;">{{ value|floatformat:3 }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if machine.is_assembly and machine.latest_record.qr_external != '-' %}
            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f0f0f0; font-size: 0.75rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span style="color: var(--dark-gray);">External:</span>
                    <span>{{ machine.latest_record.qr_external }}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--dark-gray);">Housing:</span>
                    <span>{{ machine.latest_record.qr_housing }}</span>
                </div>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div style="margin-top: 1rem; color: var(--dark-gray); font-style: italic; text-align: center;">
            No data available
        </div>
        {% endif %}
        </div>
        
        <div class="machine-status-section" data-machine-id="{{ machine.machine_id }}" style="margin-top: 1rem; font-size: 0.9rem;">
            {% if machine.is_active %}
                <span style="color: var(--success-green); font-weight: 600;">‚óè ACTIVE</span>
            {% else %}
                <span style="color: var(--danger-red); font-weight: 600;">‚óè INACTIVE</span>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Fullscreen Machine Detail Modal -->
<div id="machineModal" class="modal">
    <div class="modal-content" style="max-width: 100%; width: 95%; height:97%">
        <span class="modal-close" onclick="closeMachineModal()">&times;</span>
        <h2 id="machineModalTitle">
            Machine Details
            <span id="modalConnectionStatus" style="font-size: 0.8rem; margin-left: 1rem;">
                <span class="status-indicator status-active"></span> Live
            </span>
        </h2>
        
        <div class="modal-body">
            <div id="machineModalContent">
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 2rem;">‚è≥</div>
                    <p>Loading machine data...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentMachineId = null;
let dashboardEventSource = null;
let machineEventSource = null;

// Parse timestamp string "10/11/2025, 3:40:33 pm" to Date object
function parseCustomTimestamp(timestamp) {
    if (!timestamp) return null;
    
    try {
        // Already a Date object
        if (timestamp instanceof Date) return timestamp;
        
        // Try standard ISO format first
        if (timestamp.includes('T') || (timestamp.includes('-') && !timestamp.includes(','))) {
            const date = new Date(timestamp);
            if (!isNaN(date.getTime())) return date;
        }
        
        // Parse custom format: "10/11/2025, 3:40:33 pm" or "10/11/2025, 3:40:33 PM"
        const match = timestamp.match(/(\d{1,2})\/(\d{1,2})\/(\d{4}),?\s+(\d{1,2}):(\d{2}):(\d{2})\s*(am|pm|AM|PM)/i);
        if (match) {
            let [, day, month, year, hour, minute, second, meridiem] = match;
            
            // Convert to numbers
            day = parseInt(day);
            month = parseInt(month);
            year = parseInt(year);
            hour = parseInt(hour);
            minute = parseInt(minute);
            second = parseInt(second);
            
            // Convert 12-hour to 24-hour format
            if (meridiem.toLowerCase() === 'pm' && hour !== 12) {
                hour += 12;
            } else if (meridiem.toLowerCase() === 'am' && hour === 12) {
                hour = 0;
            }
            
            // Try DD/MM/YYYY format first (more common internationally)
            let date = new Date(year, month - 1, day, hour, minute, second);
            if (!isNaN(date.getTime()) && date.getDate() === day) {
                return date;
            }
            
            // Try MM/DD/YYYY format (US format)
            date = new Date(year, day - 1, month, hour, minute, second);
            if (!isNaN(date.getTime())) {
                return date;
            }
        }
        
        // Fallback: try native Date parsing
        const date = new Date(timestamp);
        if (!isNaN(date.getTime())) return date;
        
        return null;
    } catch (e) {
        console.error('Error parsing timestamp:', e, timestamp);
        return null;
    }
}

// Format date only (e.g., "Nov 10, 2025")
function formatDate(timestamp) {
    if (!timestamp) return '-';
    
    const date = parseCustomTimestamp(timestamp);
    if (!date) return timestamp;
    
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
    });
}

// Format time only in 12-hour format (e.g., "3:40:33 PM")
function formatTime(timestamp) {
    if (!timestamp) return '-';
    
    const date = parseCustomTimestamp(timestamp);
    if (!date) return timestamp;
    
    return date.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
    });
}

// Format full date and time (e.g., "Nov 10, 2025, 3:40:33 PM")
function formatDateTime(timestamp) {
    if (!timestamp) return '-';
    
    const date = parseCustomTimestamp(timestamp);
    if (!date) return timestamp;
    
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
    }) + ', ' + date.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
    });
}

// Format timestamps on page load
function formatAllTimestamps() {
    // Format date elements
    document.querySelectorAll('[data-timestamp-date]').forEach(element => {
        const timestamp = element.getAttribute('data-timestamp-date');
        element.textContent = formatDate(timestamp);
    });
    
    // Format time elements
    document.querySelectorAll('[data-timestamp-time]').forEach(element => {
        const timestamp = element.getAttribute('data-timestamp-time');
        element.textContent = formatTime(timestamp);
    });
    
    // Format full datetime elements
    document.querySelectorAll('[data-timestamp-full]').forEach(element => {
        const timestamp = element.getAttribute('data-timestamp-full');
        element.textContent = formatDateTime(timestamp);
    });
}

// Initialize dashboard real-time updates
function initDashboardStream() {
    if (dashboardEventSource) {
        dashboardEventSource.close();
    }
    
    dashboardEventSource = new EventSource('/stream/dashboard/');
    
    dashboardEventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            if (data.type === 'update' && data.machines) {
                updateDashboardMachines(data.machines);
            }
        } catch (error) {
            console.error('Error parsing dashboard update:', error);
        }
    };
    
    dashboardEventSource.onerror = function(error) {
        console.error('Dashboard stream error:', error);
        updateConnectionStatus(false);
        
        // Attempt to reconnect after 5 seconds
        setTimeout(() => {
            console.log('Attempting to reconnect dashboard stream...');
            initDashboardStream();
        }, 5000);
    };
    
    dashboardEventSource.onopen = function() {
        console.log('Dashboard stream connected');
        updateConnectionStatus(true);
    };
}

// Update connection status indicator
function updateConnectionStatus(connected) {
    const statusEl = document.getElementById('connectionStatus');
    if (statusEl) {
        const indicator = statusEl.querySelector('.status-indicator');
        if (connected) {
            indicator.className = 'status-indicator status-active';
            statusEl.innerHTML = '<span class="status-indicator status-active"></span> Live';
        } else {
            indicator.className = 'status-indicator status-inactive';
            statusEl.innerHTML = '<span class="status-indicator status-inactive"></span> Reconnecting...';
        }
    }
}

// Update modal connection status
function updateModalConnectionStatus(connected) {
    const statusEl = document.getElementById('modalConnectionStatus');
    if (statusEl) {
        if (connected) {
            statusEl.innerHTML = '<span class="status-indicator status-active"></span> Live';
        } else {
            statusEl.innerHTML = '<span class="status-indicator status-inactive"></span> Reconnecting...';
        }
    }
}

// Update dashboard machine cards with real-time data
function updateDashboardMachines(machines) {
    machines.forEach(machine => {
        const card = document.getElementById(`machine-card-${machine.machine_id}`);
        if (!card) return;
        
        // Add subtle animation for update
        card.style.transition = 'box-shadow 0.3s ease';
        card.style.boxShadow = '0 0 15px rgba(0, 102, 204, 0.3)';
        setTimeout(() => {
            card.style.boxShadow = '';
        }, 1000);
        
        // Update the machine card HTML with fresh data
        const machineHeader = card.querySelector('.machine-grid-header');
        const statusIndicator = machineHeader.querySelector('.status-indicator');
        
        // Update status indicator in header
        if (statusIndicator && machine.is_active !== undefined) {
            statusIndicator.className = machine.is_active ? 
                'status-indicator status-active' : 
                'status-indicator status-inactive';
        }
        
        // Find sections using data attributes (more reliable)
        const dataSection = card.querySelector(`.machine-data-section[data-machine-id="${machine.machine_id}"]`);
        const activeStatusSection = card.querySelector(`.machine-status-section[data-machine-id="${machine.machine_id}"]`);
        
        // Update latest record section
        if (dataSection) {
            if (machine.latest_record) {
                let recordHTML = `
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--light-gray);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--dark-gray); font-size: 0.85rem;">Latest QR:</span>
                            <strong style="font-size: 0.85rem;">${machine.latest_record.qr_code}</strong>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.25rem; margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--dark-gray); font-size: 0.85rem;">Date:</span>
                                <span style="font-size: 0.85rem;">${formatDate(machine.latest_record.prep_timestamp)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--dark-gray); font-size: 0.85rem;">Time:</span>
                                <span style="font-size: 0.85rem;">${formatTime(machine.latest_record.prep_timestamp)}</span>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--dark-gray); font-size: 0.85rem;">Status:</span>
                `;
                
                // Add status badge
                if (machine.latest_record.post_status === 'OK') {
                    recordHTML += '<span class="status-badge status-ok" style="font-size: 0.8rem;">‚úÖ OK</span>';
                } else if (machine.latest_record.post_status === 'NG') {
                    recordHTML += '<span class="status-badge status-ng" style="font-size: 0.8rem;">‚ùå NG</span>';
                } else {
                    recordHTML += '<span class="status-badge status-inprogress" style="font-size: 0.8rem;">‚è≥ Pending</span>';
                }
                recordHTML += '</div>';
                
                // Add gauge values if present
                if (machine.latest_record.gauge_values && Object.keys(machine.latest_record.gauge_values).length > 0) {
                    recordHTML += `
                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f0f0f0;">
                            <div style="color: var(--dark-gray); font-size: 0.8rem; margin-bottom: 0.5rem;">Gauge Values:</div>
                    `;
                    for (const [key, value] of Object.entries(machine.latest_record.gauge_values)) {
                        recordHTML += `
                            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                                <span>${key}:</span>
                                <span style="font-weight: 600;">${parseFloat(value).toFixed(3)}</span>
                            </div>
                        `;
                    }
                    recordHTML += '</div>';
                }
                
                // Add assembly QR codes if present
                if (machine.is_assembly && machine.latest_record.qr_external && machine.latest_record.qr_external !== '-') {
                    recordHTML += `
                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f0f0f0; font-size: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span style="color: var(--dark-gray);">External:</span>
                                <span>${machine.latest_record.qr_external}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--dark-gray);">Housing:</span>
                                <span>${machine.latest_record.qr_housing}</span>
                            </div>
                        </div>
                    `;
                }
                
                recordHTML += '</div>';
                dataSection.innerHTML = recordHTML;
            } else {
                dataSection.innerHTML = '<div style="margin-top: 1rem; color: var(--dark-gray); font-style: italic; text-align: center;">No data available</div>';
            }
        }
        
        // Update active/inactive status
        if (activeStatusSection) {
            if (machine.is_active) {
                activeStatusSection.innerHTML = '<span style="color: var(--success-green); font-weight: 600;">‚óè ACTIVE</span>';
            } else {
                activeStatusSection.innerHTML = '<span style="color: var(--danger-red); font-weight: 600;">‚óè INACTIVE</span>';
            }
        }
    });
}

// Initialize machine modal real-time updates
function initMachineStream(machineId) {
    if (machineEventSource) {
        machineEventSource.close();
    }
    
    machineEventSource = new EventSource(`/stream/machine/${machineId}/`);
    
    machineEventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            if (data.type === 'update') {
                renderMachineData(data);
                
                // Add visual feedback for update
                const content = document.getElementById('machineModalContent');
                if (content) {
                    content.style.transition = 'opacity 0.2s ease';
                    content.style.opacity = '0.7';
                    setTimeout(() => {
                        content.style.opacity = '1';
                    }, 200);
                }
            }
        } catch (error) {
            console.error('Error parsing machine update:', error);
        }
    };
    
    machineEventSource.onerror = function(error) {
        console.error('Machine stream error:', error);
        updateModalConnectionStatus(false);
        
        // Attempt to reconnect after 5 seconds
        setTimeout(() => {
            if (currentMachineId === machineId) {
                console.log('Attempting to reconnect machine stream...');
                initMachineStream(machineId);
            }
        }, 5000);
    };
    
    machineEventSource.onopen = function() {
        console.log('Machine stream connected');
        updateModalConnectionStatus(true);
    };
}

function openMachineModal(machineId, machineName) {
    currentMachineId = machineId;
    document.getElementById('machineModalTitle').innerHTML = `
        ${machineName}
        <span id="modalConnectionStatus" style="font-size: 0.8rem; margin-left: 1rem;">
            <span class="status-indicator status-active"></span> Connecting...
        </span>
    `;
    document.getElementById('machineModal').style.display = 'flex';
    
    // Load initial machine data
    fetch(`/api/machine/${machineId}/`)
        .then(response => response.json())
        .then(data => {
            renderMachineData(data);
            // Start real-time updates
            initMachineStream(machineId);
        })
        .catch(error => {
            document.getElementById('machineModalContent').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--danger-red);">
                    <div style="font-size: 2rem;">‚ö†Ô∏è</div>
                    <p>Error loading machine data</p>
                </div>
            `;
        });
}

function closeMachineModal() {
    document.getElementById('machineModal').style.display = 'none';
    currentMachineId = null;
    
    // Close machine stream
    if (machineEventSource) {
        machineEventSource.close();
        machineEventSource = null;
    }
}

function renderMachineData(data) {
    const content = document.getElementById('machineModalContent');
    
    if (!data.records || data.records.length === 0) {
        content.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
                <div style="font-size: 2rem;">üìä</div>
                <h3>No data available</h3>
                <p>Waiting for production data...</p>
            </div>
        `;
        return;
    }
    
    // Create table with data
    let tableHTML = `
        <div class="data-table-container" style="max-height: 90vh; overflow-y: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th colspan="4" style="background: rgba(0, 102, 204, 0.1); text-align: center;">Preprocessing</th>
                        <th rowspan="2" style="background: var(--light-gray); vertical-align: middle;">QR Code</th>
                        <th colspan="4" style="background: rgba(0, 168, 204, 0.1); text-align: center;">Postprocessing</th>
                    </tr>
                    <tr>
                        <th style="background: rgba(0, 102, 204, 0.05);">ID</th>
                        <th style="background: rgba(0, 102, 204, 0.05);">Date</th>
                        <th style="background: rgba(0, 102, 204, 0.05);">Time</th>
                        <th style="background: rgba(0, 102, 204, 0.05);">Status</th>
                        <th style="background: rgba(0, 168, 204, 0.05);">ID</th>
                        <th style="background: rgba(0, 168, 204, 0.05);">Date</th>
                        <th style="background: rgba(0, 168, 204, 0.05);">Time</th>
                        <th style="background: rgba(0, 168, 204, 0.05);">Status/Values</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.records.forEach(record => {
        const prepDate = formatDate(record.prep_timestamp);
        const prepTime = formatTime(record.prep_timestamp);
        const postDate = record.post_timestamp ? formatDate(record.post_timestamp) : '-';
        const postTime = record.post_timestamp ? formatTime(record.post_timestamp) : '-';
        
        // Build postprocessing status/values cell
        let postStatusCell = '-';
        if (record.post_status === 'Pending') {
            postStatusCell = '<span class="status-badge status-inprogress">‚è≥ Pending</span>';
        } else if (record.post_status === 'OK') {
            if (record.gauge_values && Object.keys(record.gauge_values).length > 0) {
                // Show gauge values
                let gaugeHTML = '<span class="status-badge status-ok">‚úÖ OK</span><br><small>';
                for (const [key, value] of Object.entries(record.gauge_values)) {
                    gaugeHTML += `${key}: ${value.toFixed(3)}<br>`;
                }
                gaugeHTML += '</small>';
                postStatusCell = gaugeHTML;
            } else {
                postStatusCell = '<span class="status-badge status-ok">‚úÖ OK</span>';
            }
        } else if (record.post_status === 'NG') {
            postStatusCell = '<span class="status-badge status-ng">‚ùå NG</span>';
        }
        
        // Add assembly QR codes if applicable
        let qrCodeCell = `<strong>${record.qr_code}</strong>`;
        if (data.is_assembly && record.qr_external && record.qr_external !== '-') {
            qrCodeCell += `<br><small style="color: var(--dark-gray);">
                Ext: ${record.qr_external}<br>
                House: ${record.qr_housing}
            </small>`;
        }
        
        tableHTML += `
            <tr class="${record.status_class}">
                <td>${record.prep_id}</td>
                <td><small>${prepDate}</small></td>
                <td><small>${prepTime}</small></td>
                <td><span class="status-badge status-ok">‚úÖ ${record.prep_status}</span></td>
                <td>${qrCodeCell}</td>
                <td>${record.post_id || '-'}</td>
                <td><small>${postDate}</small></td>
                <td><small>${postTime}</small></td>
                <td>${postStatusCell}</td>
            </tr>
        `;
    });
    
    tableHTML += `
                </tbody>
            </table>
        </div>
    `;
    
    content.innerHTML = tableHTML;
}

function searchQR() {
    const qrCode = document.getElementById('qr-search').value.trim();
    if (qrCode) {
        fetch(`/api/search/?qr=${encodeURIComponent(qrCode)}`)
            .then(response => response.json())
            .then(data => {
                if (data.results && data.results.length > 0) {
                    let message = `Found QR Code "${data.qr_code}" in:\n\n`;
                    data.results.forEach(result => {
                        message += `${result.machine}: ${result.preprocessing_count} prep, ${result.postprocessing_count} post\n`;
                    });
                    alert(message);
                } else {
                    alert(`QR Code "${data.qr_code}" not found in any machine.`);
                }
            });
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('machineModal');
    if (event.target == modal) {
        closeMachineModal();
    }
}

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeMachineModal();
    }
});

// Initialize dashboard stream and format timestamps on page load
document.addEventListener('DOMContentLoaded', function() {
    formatAllTimestamps();
    initDashboardStream();
});

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    if (dashboardEventSource) {
        dashboardEventSource.close();
    }
    if (machineEventSource) {
        machineEventSource.close();
    }
});
</script>
{% endblock %}
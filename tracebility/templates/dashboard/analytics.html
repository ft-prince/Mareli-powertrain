{% extends 'dashboard/base.html' %}

{% block title %}Enhanced Analytics - Manufacturing Traceability{% endblock %}

{% block content %}
<div class="analytics-container">
    <h2 style="margin-bottom: 1.5rem; color: var(--dark-coral);">üìä Production Analytics & OEE Dashboard</h2>
    
    <!-- ========================================================================= -->
    <!-- INFORMATION PANEL - Collapsible calculation explanations -->
    <!-- ========================================================================= -->
    <div class="info-panel-card">
        <div class="info-panel-header" onclick="toggleInfoPanel()">
            <div class="info-panel-title">
                <span class="info-icon">‚ÑπÔ∏è</span>
                <h3>üìä How Are These Metrics Calculated?</h3>
            </div>
            <div class="info-panel-toggle" id="infoPanelToggle">
                <span class="toggle-icon">‚ñº</span>
            </div>
        </div>
        
        <div class="info-panel-content" id="infoPanelContent" style="display: none;">
            
            <!-- OEE Calculation -->
            <div class="info-section">
                <div class="info-section-header" onclick="toggleInfoSection('oeeInfo')">
                    <span class="section-icon">üéØ</span>
                    <h4>OEE (Overall Equipment Effectiveness)</h4>
                    <span class="section-toggle" id="oeeInfoToggle">‚ñ∂</span>
                </div>
                <div class="info-section-content" id="oeeInfo" style="display: none;">
                    <div class="formula-box">
                        <div class="formula-main">
                            <strong>OEE = Availability √ó Performance √ó Quality</strong>
                        </div>
                        <div class="formula-breakdown">
                            <div class="formula-item">
                                <span class="formula-label">Availability:</span>
                                <span class="formula-value">Operating Time √∑ Loading Time (430 min)</span>
                                <p class="formula-explanation">Measures the percentage of scheduled time that the operation is available to operate. Loading time is fixed at 430 minutes per shift.</p>
                            </div>
                            <div class="formula-item">
                                <span class="formula-label">Performance:</span>
                                <span class="formula-value">Net Operating Time √∑ Operating Time</span>
                                <p class="formula-explanation">Measures the speed at which the work center runs as a percentage of its designed speed.</p>
                            </div>
                            <div class="formula-item">
                                <span class="formula-label">Quality:</span>
                                <span class="formula-value">Good Units √∑ Total Units</span>
                                <p class="formula-explanation">Measures the quality of parts produced (OK parts vs total completed parts).</p>
                            </div>
                        </div>
                        
                        <div class="example-box">
                            <h5>üìù Example Calculation:</h5>
                            <div class="example-content">
                                <p><strong>Given:</strong></p>
                                <ul>
                                    <li>Loading Time: 430 minutes</li>
                                    <li>Standard Cycle Time: 2.17 min (OP-110A - Turning Piston)</li>
                                    <li>Expected Parts: 430 √∑ 2.17 = <strong>198 parts</strong></li>
                                    <li>Actual Parts Produced: <strong>195 parts</strong></li>
                                    <li>OK Parts: 192 | NG Parts: 3</li>
                                </ul>
                                
                                <p><strong>Calculations:</strong></p>
                                <ul>
                                    <li>Parts Deficit: 198 - 195 = <strong>3 parts</strong></li>
                                    <li>Downtime: 3 √ó 2.17 = <strong>6.51 minutes</strong></li>
                                    <li>Operating Time: 430 - 6.51 = <strong>423.49 min</strong></li>
                                </ul>
                                
                                <p><strong>Results:</strong></p>
                                <ul>
                                    <li>Availability: 423.49 √∑ 430 = <strong class="success-text">98.49%</strong></li>
                                    <li>Performance: 423.49 √∑ 423.49 = <strong class="success-text">100%</strong></li>
                                    <li>Quality: 192 √∑ 195 = <strong class="success-text">98.46%</strong></li>
                                    <li><strong>OEE: 98.49% √ó 100% √ó 98.46% = <span class="highlight-text">96.99%</span></strong></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="benchmark-box">
                            <h5>üéØ OEE Benchmarks:</h5>
                            <div class="benchmark-grid">
                                <div class="benchmark-item excellent">
                                    <span class="benchmark-value">‚â• 85%</span>
                                    <span class="benchmark-label">World Class</span>
                                </div>
                                <div class="benchmark-item good">
                                    <span class="benchmark-value">70-84%</span>
                                    <span class="benchmark-label">Good</span>
                                </div>
                                <div class="benchmark-item needs-improvement">
                                    <span class="benchmark-value">< 70%</span>
                                    <span class="benchmark-label">Needs Improvement</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Shift-Wise Analysis -->
            <div class="info-section">
                <div class="info-section-header" onclick="toggleInfoSection('shiftInfo')">
                    <span class="section-icon">üåì</span>
                    <h4>Shift-Wise Production Analysis</h4>
                    <span class="section-toggle" id="shiftInfoToggle">‚ñ∂</span>
                </div>
                <div class="info-section-content" id="shiftInfo" style="display: none;">
                    <div class="shift-definitions">
                        <div class="shift-def-item shift-a-bg">
                            <h5>üåÖ Shift A - Morning</h5>
                            <p><strong>Time:</strong> 06:00 AM to 14:00 PM (8 hours)</p>
                            <p><strong>Calculation:</strong> All parts with timestamps between 06:00 and 14:00 are counted in Shift A</p>
                        </div>
                        <div class="shift-def-item shift-b-bg">
                            <h5>‚òÄÔ∏è Shift B - Afternoon</h5>
                            <p><strong>Time:</strong> 14:00 PM to 22:00 PM (8 hours)</p>
                            <p><strong>Calculation:</strong> All parts with timestamps between 14:00 and 22:00 are counted in Shift B</p>
                        </div>
                        <div class="shift-def-item shift-c-bg">
                            <h5>üåô Shift C - Night</h5>
                            <p><strong>Time:</strong> 22:00 PM to 06:00 AM (8 hours)</p>
                            <p><strong>Calculation:</strong> All parts with timestamps between 22:00-23:59 and 00:00-06:00 are counted in Shift C (crosses midnight)</p>
                        </div>
                    </div>
                    
                    <div class="shift-metrics">
                        <h5>üìä Metrics Per Shift:</h5>
                        <ul>
                            <li><strong>Total Parts:</strong> Count of all parts produced during shift hours</li>
                            <li><strong>OK/NG Breakdown:</strong> Quality status of parts produced in the shift</li>
                            <li><strong>Shift OEE:</strong> Individual OEE calculated using only that shift's data</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Cycle Time Tracking -->
            <div class="info-section">
                <div class="info-section-header" onclick="toggleInfoSection('cycleTimeInfo')">
                    <span class="section-icon">‚è±Ô∏è</span>
                    <h4>Cycle Time Tracking (Actual vs Standard)</h4>
                    <span class="section-toggle" id="cycleTimeInfoToggle">‚ñ∂</span>
                </div>
                <div class="info-section-content" id="cycleTimeInfo" style="display: none;">
                    <div class="cycle-time-explanation">
                        <div class="ct-item">
                            <h5>üìã Standard Cycle Time (CT)</h5>
                            <p>The expected/target time for each operation, based on engineering studies and production standards.</p>
                            <div class="ct-table-container">
                                <table class="ct-table">
                                    <thead>
                                        <tr>
                                            <th>Operation</th>
                                            <th>OP Code</th>
                                            <th>Std CT (sec)</th>
                                            <th>Std CT (min)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Turning Piston</td>
                                            <td>OP-110A/B</td>
                                            <td>130</td>
                                            <td>2.17</td>
                                        </tr>
                                        <tr>
                                            <td>Turning Housing</td>
                                            <td>OP-130A/B/C/D</td>
                                            <td>255</td>
                                            <td>4.25</td>
                                        </tr>
                                        <tr>
                                            <td>Honing Machine 1#</td>
                                            <td>OP-140A</td>
                                            <td>135</td>
                                            <td>2.25</td>
                                        </tr>
                                        <tr>
                                            <td>Honing Machine 2#</td>
                                            <td>OP-140B</td>
                                            <td>73</td>
                                            <td>1.22</td>
                                        </tr>
                                        <tr>
                                            <td>Deburring</td>
                                            <td>OP-160</td>
                                            <td>32</td>
                                            <td>0.53</td>
                                        </tr>
                                        <tr>
                                            <td>Painting</td>
                                            <td>OP-85</td>
                                            <td>39</td>
                                            <td>0.65</td>
                                        </tr>
                                        <tr>
                                            <td>Piston Oring Lube</td>
                                            <td>OP-90</td>
                                            <td>42</td>
                                            <td>0.70</td>
                                        </tr>
                                        <tr>
                                            <td>Piston Pre Assy</td>
                                            <td>OP-40A/B/C/D</td>
                                            <td>50</td>
                                            <td>0.83</td>
                                        </tr>
                                        <tr>
                                            <td>HP Leak Test</td>
                                            <td>OP-80</td>
                                            <td>70</td>
                                            <td>1.17</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="ct-item">
                            <h5>üìä Actual Cycle Time</h5>
                            <p><strong>Calculation:</strong> Time difference between preprocessing (part entry) and postprocessing (part exit) timestamps.</p>
                            <div class="formula-box-small">
                                <code>Actual CT = Post-processing Time - Pre-processing Time</code>
                            </div>
                            <p><strong>Example:</strong> Part scanned in at 10:15:30, scanned out at 10:18:00<br>
                            Actual CT = 2 minutes 30 seconds = <strong>2.50 minutes</strong></p>
                        </div>
                        
                        <div class="ct-item">
                            <h5>üìà Average Cycle Time</h5>
                            <p>The mean of all actual cycle times for the selected period and machines.</p>
                            <div class="formula-box-small">
                                <code>Avg CT = Sum of all actual CTs √∑ Number of parts</code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Rejection Rate -->
            <div class="info-section">
                <div class="info-section-header" onclick="toggleInfoSection('rejectionInfo')">
                    <span class="section-icon">üìâ</span>
                    <h4>Rejection Rate Trends</h4>
                    <span class="section-toggle" id="rejectionInfoToggle">‚ñ∂</span>
                </div>
                <div class="info-section-content" id="rejectionInfo" style="display: none;">
                    <div class="rejection-explanation">
                        <div class="formula-box">
                            <div class="formula-main">
                                <strong>Rejection Rate = (NG Parts √∑ (OK Parts + NG Parts)) √ó 100%</strong>
                            </div>
                            <p class="formula-note"><em>Note: Pending parts are not included in rejection rate calculation</em></p>
                        </div>
                        
                        <div class="example-box">
                            <h5>üìù Example:</h5>
                            <p>If production yields 950 OK parts and 50 NG parts:</p>
                            <ul>
                                <li>Total Completed: 950 + 50 = 1,000 parts</li>
                                <li>Rejection Rate: (50 √∑ 1,000) √ó 100% = <strong>5.00%</strong></li>
                            </ul>
                        </div>
                        
                        <div class="benchmark-box">
                            <h5>üéØ Quality Targets:</h5>
                            <div class="target-grid">
                                <div class="target-item excellent">
                                    <span class="target-value">< 1%</span>
                                    <span class="target-label">Excellent</span>
                                </div>
                                <div class="target-item good">
                                    <span class="target-value">1-3%</span>
                                    <span class="target-label">Acceptable</span>
                                </div>
                                <div class="target-item needs-improvement">
                                    <span class="target-value">> 3%</span>
                                    <span class="target-label">Action Required</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Machine & Model Breakdown -->
            <div class="info-section">
                <div class="info-section-header" onclick="toggleInfoSection('breakdownInfo')">
                    <span class="section-icon">üîß</span>
                    <h4>Machine and Model-Level Breakdowns</h4>
                    <span class="section-toggle" id="breakdownInfoToggle">‚ñ∂</span>
                </div>
                <div class="info-section-content" id="breakdownInfo" style="display: none;">
                    <div class="breakdown-explanation">
                        <div class="breakdown-item">
                            <h5>üè≠ Machine Breakdown</h5>
                            <p>Aggregates production data by individual machine/station:</p>
                            <ul>
                                <li><strong>Total Parts:</strong> All parts processed by this machine</li>
                                <li><strong>OK/NG Count:</strong> Quality breakdown per machine</li>
                                <li><strong>Yield Rate:</strong> (OK √∑ (OK + NG)) √ó 100%</li>
                            </ul>
                            <p class="info-note">üí° <em>Use this to identify underperforming machines or bottlenecks</em></p>
                        </div>
                        
                        <div class="breakdown-item">
                            <h5>üì¶ Model Breakdown</h5>
                            <p>Aggregates production data by part model/variant:</p>
                            <ul>
                                <li><strong>Total Parts:</strong> All parts of this model produced</li>
                                <li><strong>OK/NG Count:</strong> Quality breakdown per model</li>
                                <li><strong>Yield Rate:</strong> (OK √∑ (OK + NG)) √ó 100%</li>
                            </ul>
                            <p class="info-note">üí° <em>Use this to identify problematic part designs or variants</em></p>
                        </div>
                        
                        <div class="breakdown-item">
                            <h5>üìä Productivity Formula</h5>
                            <div class="formula-box-small">
                                <code>Productivity = (OK Parts √∑ Total Parts) √ó 100%</code>
                            </div>
                            <p>Measures overall production efficiency including pending parts</p>
                        </div>
                        
                        <div class="breakdown-item">
                            <h5>üéØ Yield Rate Formula</h5>
                            <div class="formula-box-small">
                                <code>Yield Rate = (OK Parts √∑ (OK Parts + NG Parts)) √ó 100%</code>
                            </div>
                            <p>Measures quality of completed parts only (excludes pending)</p>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>


    <!-- Filters Section -->
    <div class="filters-card">
        <h3 style="color: var(--dark-coral); margin-bottom: 1rem;">‚öôÔ∏è Filters & Controls</h3>
        <div class="filter-grid">
            <div class="filter-group">
                <label for="dateRange">Date Range</label>
                <select id="dateRange" onchange="handleDateRangeChange()">
                    <option value="today">Today</option>
                    <option value="yesterday">Yesterday</option>
                    <option value="week" selected>Last 7 Days</option>
                    <option value="month">Last 30 Days</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="startDate">Start Date</label>
                <input type="date" id="startDate" disabled>
            </div>
            
            <div class="filter-group">
                <label for="endDate">End Date</label>
                <input type="date" id="endDate" disabled>
            </div>
            
            <div class="filter-group">
                <label for="machineFilter">Machine</label>
                <select id="machineFilter">
                    <option value="all">All Machines</option>
                    <optgroup label="CNC Machines">
                        <option value="dmg_mori1op_110a">CNC 1 (OP-110A)</option>
                        <option value="dmg_mori2op_110b">CNC 2 (OP-110B)</option>
                        <option value="dmg_mori3op_130d">CNC 3 (OP-130D)</option>
                        <option value="dmg_mori4op_130c">CNC 4 (OP-130C)</option>
                        <option value="dmg_mori5op_130b">CNC 5 (OP-130B)</option>
                        <option value="dmg_mori6op_130a">CNC 6 (OP-130A)</option>
                    </optgroup>
                    <optgroup label="Gauge">
                        <option value="gauge1op_115">Gauge 1</option>
                        <option value="gauge2op_135b">Gauge 2</option>
                        <option value="gauge3op_135a">Gauge 3</option>
                    </optgroup>
                    <optgroup label="Honing">
                        <option value="honing1140a">Honing 1</option>
                        <option value="honing2140b">Honing 2</option>
                    </optgroup>
                    <optgroup label="Processing">
                        <option value="deburringop_160">Deburring</option>
                        <option value="prewashing_loadingop_150">Prewashing Load</option>
                        <option value="prewashing_unloadingop_150">Prewashing Unload</option>
                        <option value="finlwashing_loadingop_170">Final Washing Load</option>
                        <option value="finlwashing_unloadingop_170">Final Washing Unload</option>
                    </optgroup>
                    <optgroup label="Final">
                        <option value="paintingop85">Painting</option>
                        <option value="lubricationop90">Lubrication</option>
                    </optgroup>
                    <optgroup label="Assembly">
                        <option value="op40a">Assembly OP40A</option>
                        <option value="op40b">Assembly OP40B</option>
                        <option value="op40c">Assembly OP40C</option>
                        <option value="op40d">Assembly OP40D</option>
                    </optgroup>
                    <optgroup label="Testing">
                        <option value="op80_leak_test">OP80 Leak Test</option>
                    </optgroup>
                </select>
            </div>            
            <div class="filter-group">
                <label for="statusFilter">Status</label>
                <select id="statusFilter">
                    <option value="all">All Status</option>
                    <option value="OK">OK</option>
                    <option value="NG">NG</option>
                    <option value="Pending">Pending</option>
                </select>
            </div>
        </div>
        
        <div class="filter-actions">
            <button class="filter-btn filter-btn-primary" onclick="applyFilters()">
                üîç Apply Filters
            </button>
            <button class="filter-btn filter-btn-secondary" onclick="resetFilters()">
                üîÑ Reset
            </button>
    <!-- Export Dropdown -->
    <div class="export-dropdown">
        <button class="filter-btn filter-btn-export" onclick="toggleExportMenu()">
            üìä Export Data ‚ñº
        </button>
        <div class="export-menu" id="exportMenu" style="display: none;">
            <button class="export-menu-item" onclick="exportExcel()">
                <span class="export-icon">üìó</span>
                <div class="export-details">
                    <div class="export-title">Excel (Formatted)</div>
                    <div class="export-subtitle">Multi-sheet with charts & colors</div>
                </div>
            </button>
            <button class="export-menu-item" onclick="exportData()">
                <span class="export-icon">üìÑ</span>
                <div class="export-details">
                    <div class="export-title">CSV (Simple)</div>
                    <div class="export-subtitle">Raw data for analysis</div>
                </div>
            </button>
            <button class="export-menu-item" onclick="exportCharts()">
                <span class="export-icon">üìà</span>
                <div class="export-details">
                    <div class="export-title">Print/PDF</div>
                    <div class="export-subtitle">Charts & visualizations</div>
                </div>
            </button>
        </div>
    </div>
</div>

        </div>
    </div>
    
    <!-- OEE METRICS SECTION -->
    <div class="oee-section">
        <h3 style="color: var(--dark-coral); margin-bottom: 1rem;">üéØ Overall Equipment Effectiveness (OEE)</h3>
        <div class="oee-grid">
            <div class="oee-card oee-main">
                <div class="oee-icon">üèÜ</div>
                <div class="oee-value" id="oeeValue">0%</div>
                <div class="oee-label">Overall OEE</div>
                <div class="oee-formula">Availability √ó Performance √ó Quality</div>
            </div>
            
            <div class="oee-card">
                <div class="oee-icon">‚è∞</div>
                <div class="oee-value" id="availabilityValue" style="color: #3498db;">0%</div>
                <div class="oee-label">Availability</div>
                <div class="oee-sublabel">Operating Time / Loading Time</div>
            </div>
            
            <div class="oee-card">
                <div class="oee-icon">‚ö°</div>
                <div class="oee-value" id="performanceValue" style="color: #9b59b6;">0%</div>
                <div class="oee-label">Performance</div>
                <div class="oee-sublabel">Net Operating / Operating Time</div>
            </div>
            
            <div class="oee-card">
                <div class="oee-icon">‚úÖ</div>
                <div class="oee-value" id="qualityValue" style="color: var(--success-green);">0%</div>
                <div class="oee-label">Quality</div>
                <div class="oee-sublabel">Good Units / Total Units</div>
            </div>
            
            <div class="oee-card">
                <div class="oee-icon">‚è∏Ô∏è</div>
                <div class="oee-value" id="downtimeValue" style="color: var(--danger-red);">0 min</div>
                <div class="oee-label">Estimated Downtime</div>
                <div class="oee-sublabel">Based on production gap</div>
            </div>
        </div>
    </div>
    
    <!-- Key Performance Indicators -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üì¶</div>
            <div class="stat-value" id="totalParts">0</div>
            <div class="stat-label">Total Parts Processed</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-value" id="okParts" style="color: var(--success-green);">0</div>
            <div class="stat-label">OK Parts</div>
            <div class="stat-change positive" id="okPercentage">0%</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">‚ùå</div>
            <div class="stat-value" id="ngParts" style="color: var(--danger-red);">0</div>
            <div class="stat-label">NG Parts</div>
            <div class="stat-change negative" id="ngPercentage">0%</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">üìâ</div>
            <div class="stat-value" id="rejectionRate" style="color: var(--danger-red);">0%</div>
            <div class="stat-label">Rejection Rate</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">‚è±Ô∏è</div>
            <div class="stat-value" id="avgCycleTime">0 min</div>
            <div class="stat-label">Avg Cycle Time</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-value" id="productivity">0%</div>
            <div class="stat-label">Productivity</div>
            <div class="stat-sublabel">OK Parts / Total Parts</div>
        </div>
    </div>
    
    <!-- SHIFT-WISE PRODUCTION SECTION -->
    <div class="shift-section">
        <h3 style="color: var(--dark-coral); margin-bottom: 1rem;">üåì Shift-Wise Production Analysis</h3>
        <div class="shift-grid">
            <div class="shift-card shift-a">
                <div class="shift-header">
                    <div class="shift-icon">üåÖ</div>
                    <div>
                        <div class="shift-name">Shift A</div>
                        <div class="shift-time">06:00 AM - 14:00 PM</div>
                    </div>
                </div>
                <div class="shift-stats">
                    <div class="shift-stat">
                        <div class="shift-stat-label">Total</div>
                        <div class="shift-stat-value" id="shiftATotal">0</div>
                    </div>
                    <div class="shift-stat">
                        <div class="shift-stat-label">OK</div>
                        <div class="shift-stat-value" id="shiftAOK" style="color: var(--success-green);">0</div>
                    </div>
                    <div class="shift-stat">
                        <div class="shift-stat-label">NG</div>
                        <div class="shift-stat-value" id="shiftANG" style="color: var(--danger-red);">0</div>
                    </div>
                </div>
                <div class="shift-oee">
                    <div class="shift-oee-label">Shift OEE</div>
                    <div class="shift-oee-value" id="shiftAOEE">0%</div>
                </div>
            </div>
            
            <div class="shift-card shift-b">
                <div class="shift-header">
                    <div class="shift-icon">‚òÄÔ∏è</div>
                    <div>
                        <div class="shift-name">Shift B</div>
                        <div class="shift-time">14:00 PM - 22:00 PM</div>
                    </div>
                </div>
                <div class="shift-stats">
                    <div class="shift-stat">
                        <div class="shift-stat-label">Total</div>
                        <div class="shift-stat-value" id="shiftBTotal">0</div>
                    </div>
                    <div class="shift-stat">
                        <div class="shift-stat-label">OK</div>
                        <div class="shift-stat-value" id="shiftBOK" style="color: var(--success-green);">0</div>
                    </div>
                    <div class="shift-stat">
                        <div class="shift-stat-label">NG</div>
                        <div class="shift-stat-value" id="shiftBNG" style="color: var(--danger-red);">0</div>
                    </div>
                </div>
                <div class="shift-oee">
                    <div class="shift-oee-label">Shift OEE</div>
                    <div class="shift-oee-value" id="shiftBOEE">0%</div>
                </div>
            </div>
            
            <div class="shift-card shift-c">
                <div class="shift-header">
                    <div class="shift-icon">üåô</div>
                    <div>
                        <div class="shift-name">Shift C</div>
                        <div class="shift-time">22:00 PM - 06:00 AM</div>
                    </div>
                </div>
                <div class="shift-stats">
                    <div class="shift-stat">
                        <div class="shift-stat-label">Total</div>
                        <div class="shift-stat-value" id="shiftCTotal">0</div>
                    </div>
                    <div class="shift-stat">
                        <div class="shift-stat-label">OK</div>
                        <div class="shift-stat-value" id="shiftCOK" style="color: var(--success-green);">0</div>
                    </div>
                    <div class="shift-stat">
                        <div class="shift-stat-label">NG</div>
                        <div class="shift-stat-value" id="shiftCNG" style="color: var(--danger-red);">0</div>
                    </div>
                </div>
                <div class="shift-oee">
                    <div class="shift-oee-label">Shift OEE</div>
                    <div class="shift-oee-value" id="shiftCOEE">0%</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Section -->
    <div class="charts-grid">
        <!-- OEE Gauge Chart -->
        <div class="chart-card">
            <h3>OEE Components Breakdown</h3>
            <div class="chart-container">
                <canvas id="oeeRadarChart"></canvas>
            </div>
        </div>
        
        <!-- Shift Comparison -->
        <div class="chart-card">
            <h3>Shift-Wise Production Comparison</h3>
            <div class="chart-container">
                <canvas id="shiftComparisonChart"></canvas>
            </div>
        </div>
        
        <!-- Shift Timeline (Full Width) -->
        <div class="chart-card full-width-chart">
            <h3>Shift-Wise Daily Production Timeline</h3>
            <div class="chart-container" style="height: 400px;">
                <canvas id="shiftTimelineChart"></canvas>
            </div>
        </div>
        
        <!-- Cycle Time Comparison -->
        <div class="chart-card">
            <h3>Actual vs Standard Cycle Time</h3>
            <div class="chart-container">
                <canvas id="cycleTimeChart"></canvas>
            </div>
        </div>
        
        <!-- Rejection Rate Trend -->
        <div class="chart-card">
            <h3>Rejection Rate Trend</h3>
            <div class="chart-container">
                <canvas id="rejectionTrendChart"></canvas>
            </div>
        </div>
        
        <!-- Production Timeline -->
        <div class="chart-card full-width-chart">
            <h3>Overall Production Timeline</h3>
            <div class="chart-container" style="height: 350px;">
                <canvas id="timelineChart"></canvas>
            </div>
        </div>
        
        <!-- Hourly Production -->
        <div class="chart-card">
            <h3>Hourly Production Rate</h3>
            <div class="chart-container">
                <canvas id="hourlyChart"></canvas>
            </div>
        </div>
        
        <!-- Yield Rate Trend -->
        <div class="chart-card">
            <h3>Yield Rate Trend</h3>
            <div class="chart-container">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
        
        <!-- Machine Performance -->
        <div class="chart-card">
            <h3>Machine Performance</h3>
            <div class="chart-container">
                <canvas id="machineBarChart"></canvas>
            </div>
        </div>
        
        <!-- Status Distribution -->
        <div class="chart-card">
            <h3>Status Distribution</h3>
            <div class="chart-container">
                <canvas id="statusPieChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Machine Breakdown -->
    <div class="chart-card">
        <h3>Machine Breakdown</h3>
        <div class="machine-breakdown" id="machineBreakdown">
            <!-- Populated by JavaScript -->
        </div>
    </div>
    
    <!-- Model Breakdown -->
    <div class="chart-card">
        <h3>Model Name Breakdown</h3>
        <div class="machine-breakdown" id="modelBreakdown">
            <!-- Populated by JavaScript -->
        </div>
    </div>
    
    <!-- QR Code Search Section -->
    <div class="data-table-card">
        <h3 style="color: var(--dark-coral); margin-bottom: 1rem;">üîç QR Code Search</h3>
        <div class="search-bar">
            <input type="text" id="qrSearchInput" class="search-input-analytics" placeholder="Enter QR Code to search...">
            <button class="filter-btn filter-btn-primary" onclick="searchQRCode()">
                üîç Search
            </button>
        </div>
        <div id="searchResults"></div>
    </div>
    
    <!-- Detailed Data Table -->
    <div class="data-table-card">
        <h3 style="color: var(--dark-coral); margin-bottom: 1rem;">üìã Detailed Data (Latest 100 Records)</h3>
        <div class="data-table-container" style="max-height: 500px; overflow-y: auto;">
            <table class="data-table" id="detailedDataTable">
                <thead>
                    <tr>
                        <th>Machine</th>
                        <th>Model</th>
                        <th>QR Code</th>
                        <th>Timestamp</th>
                        <th>Shift</th>
                        <th>Cycle Time</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="detailedDataBody">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
</div>

<style>
    /* Enhanced Analytics Styles */
    .analytics-container {
        padding: 1rem;
    }
    
    .filters-card {
        background: var(--white);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 6px var(--shadow);
    }
    
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
    }
    
    .filter-group label {
        font-weight: 600;
        color: var(--dark-coral);
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }
    
    .filter-group select,
    .filter-group input {
        padding: 0.6rem;
        border: 2px solid var(--medium-gray);
        border-radius: 8px;
        font-size: 0.9rem;
        transition: all 0.3s;
    }
    
    .filter-group select:focus,
    .filter-group input:focus {
        outline: none;
        border-color: var(--primary-coral);
        box-shadow: 0 0 0 3px rgba(255, 119, 85, 0.1);
    }
    
    .filter-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
        flex-wrap: wrap;
    }
    
    .filter-btn {
        padding: 0.7rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.9rem;
    }
    
    .filter-btn-primary {
        background: linear-gradient(135deg, var(--dark-coral) 0%, var(--accent-orange) 100%);
        color: var(--white);
    }
    
    .filter-btn-primary:hover {
        background: linear-gradient(135deg, var(--primary-coral) 0%, var(--secondary-coral) 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px var(--shadow);
    }
    
    .filter-btn-secondary {
        background: var(--light-gray);
        color: var(--text-dark);
    }
    
    .filter-btn-secondary:hover {
        background: var(--medium-gray);
    }
    
    .filter-btn-export {
        background: var(--success-green);
        color: var(--white);
    }
    
    .filter-btn-export:hover {
        background: #00b359;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px var(--shadow);
    }
    
    /* OEE Section */
    .oee-section {
        background: var(--white);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 6px var(--shadow);
    }
    
    .oee-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    .oee-card {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s;
    }
    
    .oee-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px var(--shadow);
    }
    
    .oee-main {
        background: linear-gradient(135deg, var(--dark-coral) 0%, var(--accent-orange) 100%);
        color: var(--white);
    }
    
    .oee-icon {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }
    
    .oee-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .oee-label {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .oee-sublabel, .oee-formula {
        font-size: 0.75rem;
        opacity: 0.8;
    }
    
    /* Shift Section */
    .shift-section {
        background: var(--white);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 6px var(--shadow);
    }
    
    .shift-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
    }
    
    .shift-card {
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.3s;
    }
    
    .shift-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px var(--shadow);
    }
    
    .shift-a {
        background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
    }
    
    .shift-b {
        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        color: var(--white);
    }
    
    .shift-c {
        background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
        color: var(--white);
    }
    
    .shift-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .shift-icon {
        font-size: 2rem;
    }
    
    .shift-name {
        font-size: 1.2rem;
        font-weight: 700;
    }
    
    .shift-time {
        font-size: 0.85rem;
        opacity: 0.9;
    }
    
    .shift-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
    }
    
    .shift-stat {
        text-align: center;
    }
    
    .shift-stat-label {
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .shift-stat-value {
        font-size: 1.5rem;
        font-weight: 700;
    }
    
    .shift-oee {
        text-align: center;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 8px;
    }
    
    .shift-oee-label {
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .shift-oee-value {
        font-size: 1.75rem;
        font-weight: 700;
    }
    
    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .stat-card {
        background: var(--white);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px var(--shadow);
        text-align: center;
        transition: transform 0.3s;
    }
    
    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 12px var(--shadow);
    }
    
    .stat-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--dark-coral);
        margin-bottom: 0.25rem;
    }
    
    .stat-label {
        color: var(--dark-gray);
        font-size: 0.9rem;
    }
    
    .stat-sublabel {
        color: var(--dark-gray);
        font-size: 0.75rem;
        margin-top: 0.25rem;
    }
    
    .stat-change {
        font-size: 0.85rem;
        margin-top: 0.5rem;
        font-weight: 600;
    }
    
    .stat-change.positive {
        color: var(--success-green);
    }
    
    .stat-change.negative {
        color: var(--danger-red);
    }
    
    /* Charts */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .chart-card {
        background: var(--white);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px var(--shadow);
    }
    
    .chart-card h3 {
        color: var(--dark-coral);
        margin-bottom: 1rem;
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
    }
    
    .full-width-chart {
        grid-column: 1 / -1;
    }
    
    /* Data Tables */
    .data-table-card {
        background: var(--white);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px var(--shadow);
        margin-bottom: 1.5rem;
    }
    
    .search-bar {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .search-input-analytics {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 2px solid var(--medium-gray);
        border-radius: 8px;
        font-size: 0.9rem;
        transition: all 0.3s;
    }
    
    .search-input-analytics:focus {
        outline: none;
        border-color: var(--primary-coral);
        box-shadow: 0 0 0 3px rgba(255, 119, 85, 0.1);
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .loading-spinner {
        border: 4px solid var(--light-gray);
        border-top: 4px solid var(--dark-coral);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .machine-breakdown {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .machine-stat {
        background: var(--light-gray);
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
        transition: all 0.3s;
    }
    
    .machine-stat:hover {
        background: var(--medium-gray);
        transform: translateY(-2px);
    }
    
    .machine-stat-name {
        font-size: 0.85rem;
        color: var(--dark-gray);
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    
    .machine-stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--dark-coral);
    }
    
    @media (max-width: 768px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
        
        .filter-actions {
            flex-direction: column;
        }
        
        .filter-btn {
            width: 100%;
        }
        
        .shift-grid {
            grid-template-columns: 1fr;
        }
    }
</style>


<style>
/* Info Panel Styles */
.info-panel-card {
    background: var(--white);
    border-radius: 12px;
    padding: 0;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 6px var(--shadow);
    overflow: hidden;
    border: 2px solid #e0e0e0;
}

.info-panel-header {
    background: linear-gradient(135deg, #764ba2 0%, #764ba2 100%);
    padding: 1.25rem 1.5rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s;
}

.info-panel-header:hover {
    background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
}

.info-panel-title {
    display: flex;
    align-items: center;
    gap: 1rem;
    color: var(--white);
}

.info-panel-title h3 {
    margin: 0;
    font-size: 1.3rem;
    font-weight: 600;
}

.info-icon {
    font-size: 1.5rem;
}

.info-panel-toggle {
    color: var(--white);
    font-size: 1.5rem;
    transition: transform 0.3s;
}

.info-panel-toggle.rotated {
    transform: rotate(180deg);
}

.toggle-icon {
    display: inline-block;
    transition: transform 0.3s;
}

.info-panel-content {
    padding: 1.5rem;
    background: #f8f9fa;
}

/* Info Sections */
.info-section {
    background: var(--white);
    border-radius: 8px;
    margin-bottom: 1rem;
    overflow: hidden;
    border: 1px solid #e0e0e0;
}

.info-section-header {
    padding: 1rem 1.25rem;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    transition: all 0.3s;
}

.info-section-header:hover {
    background: linear-gradient(135deg, #c3cfe2 0%, #f5f7fa 100%);
}

.info-section-header h4 {
    margin: 0;
    flex: 1;
    font-size: 1.1rem;
    color: #333;
}

.section-icon {
    font-size: 1.5rem;
}

.section-toggle {
    font-size: 1.2rem;
    transition: transform 0.3s;
    color: #666;
}

.section-toggle.rotated {
    transform: rotate(90deg);
}

.info-section-content {
    padding: 1.5rem;
}

/* Formula Boxes */
.formula-box {
    background: #fff;
    border: 2px solid #667eea;
    border-radius: 8px;
    padding: 1.25rem;
    margin-bottom: 1rem;
}

.formula-main {
    font-size: 1.1rem;
    color: #667eea;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 6px;
    text-align: center;
}

.formula-breakdown {
    margin-top: 1rem;
}

.formula-item {
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 4px solid #667eea;
}

.formula-label {
    font-weight: 600;
    color: #333;
    display: block;
    margin-bottom: 0.25rem;
}

.formula-value {
    color: #667eea;
    font-family: 'Courier New', monospace;
    display: block;
    margin-bottom: 0.5rem;
}

.formula-explanation {
    font-size: 0.9rem;
    color: #666;
    margin: 0.5rem 0 0 0;
}

.formula-note {
    font-size: 0.9rem;
    color: #666;
    margin-top: 0.5rem;
}

.formula-box-small {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 0.75rem;
    margin: 0.75rem 0;
}

.formula-box-small code {
    color: #667eea;
    font-weight: 600;
}

/* Example Boxes */
.example-box {
    background: #fff8e1;
    border: 2px solid #ffd54f;
    border-radius: 8px;
    padding: 1.25rem;
    margin-top: 1rem;
}

.example-box h5 {
    color: #f57c00;
    margin-top: 0;
    margin-bottom: 0.75rem;
}

.example-content ul {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
}

.example-content li {
    margin-bottom: 0.5rem;
}

.success-text {
    color: #00cc66;
    font-weight: 600;
}

.highlight-text {
    color: #ff7755;
    font-size: 1.1rem;
    font-weight: 700;
}

/* Benchmark Boxes */
.benchmark-box {
    margin-top: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.benchmark-box h5 {
    margin-top: 0;
    margin-bottom: 1rem;
    color: #333;
}

.benchmark-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.benchmark-item {
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
}

.benchmark-item.excellent {
    background: #c8e6c9;
    border: 2px solid #4caf50;
}

.benchmark-item.good {
    background: #fff9c4;
    border: 2px solid #fbc02d;
}

.benchmark-item.needs-improvement {
    background: #ffcdd2;
    border: 2px solid #f44336;
}

.benchmark-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.benchmark-label {
    display: block;
    font-size: 0.9rem;
    font-weight: 600;
}

/* Shift Definitions */
.shift-definitions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.shift-def-item {
    padding: 1.25rem;
    border-radius: 8px;
    border: 2px solid #ddd;
}

.shift-def-item h5 {
    margin-top: 0;
    margin-bottom: 0.75rem;
    font-size: 1.1rem;
}

.shift-def-item p {
    margin: 0.5rem 0;
    font-size: 0.95rem;
}

.shift-a-bg {
    background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
}

.shift-b-bg {
    background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
    color: var(--white);
}

.shift-c-bg {
    background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
    color: var(--white);
}

.shift-metrics {
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.shift-metrics h5 {
    margin-top: 0;
    margin-bottom: 1rem;
}

.shift-metrics ul {
    margin: 0;
    padding-left: 1.5rem;
}

.shift-metrics li {
    margin-bottom: 0.75rem;
}

/* Cycle Time Table */
.ct-table-container {
    overflow-x: auto;
    margin: 1rem 0;
}

.ct-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.ct-table thead {
    background: #667eea;
    color: var(--white);
}

.ct-table th {
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
}

.ct-table td {
    padding: 0.75rem;
    border-bottom: 1px solid #e0e0e0;
}

.ct-table tbody tr:hover {
    background: #f8f9fa;
}

/* Cycle Time Explanation */
.cycle-time-explanation {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.ct-item h5 {
    margin-top: 0;
    margin-bottom: 0.75rem;
    color: #667eea;
}

/* Breakdown Explanation */
.breakdown-explanation {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.breakdown-item {
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #667eea;
}

.breakdown-item h5 {
    margin-top: 0;
    margin-bottom: 0.75rem;
    color: #667eea;
}

.breakdown-item ul {
    margin: 0.75rem 0;
    padding-left: 1.5rem;
}

.breakdown-item li {
    margin-bottom: 0.5rem;
}

.info-note {
    font-size: 0.9rem;
    font-style: italic;
    color: #666;
    margin-top: 0.75rem;
}

/* Target Grid */
.target-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
}

.target-item {
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
}

.target-item.excellent {
    background: #c8e6c9;
    border: 2px solid #4caf50;
}

.target-item.good {
    background: #fff9c4;
    border: 2px solid #fbc02d;
}

.target-item.needs-improvement {
    background: #ffcdd2;
    border: 2px solid #f44336;
}

.target-value {
    display: block;
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.target-label {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
}

/* Rejection Explanation */
.rejection-explanation {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .benchmark-grid,
    .shift-definitions,
    .target-grid {
        grid-template-columns: 1fr;
    }
    
    .info-panel-title h3 {
        font-size: 1.1rem;
    }
}


/* Export Dropdown Styles */
.export-dropdown {
    position: relative;
    display: inline-block;
}

.export-menu {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 0.5rem;
    background: var(--white);
    border-radius: 8px;
    box-shadow: 0 8px 16px var(--shadow);
    min-width: 280px;
    z-index: 1000;
    overflow: hidden;
    border: 2px solid var(--medium-gray);
}

.export-menu-item {
    width: 100%;
    padding: 1rem 1.25rem;
    border: none;
    background: var(--white);
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 1rem;
    text-align: left;
}

.export-menu-item:hover {
    background: var(--light-gray);
}

.export-menu-item:not(:last-child) {
    border-bottom: 1px solid var(--medium-gray);
}

.export-icon {
    font-size: 2rem;
    flex-shrink: 0;
}

.export-details {
    flex: 1;
}

.export-title {
    font-weight: 600;
    color: var(--dark-coral);
    font-size: 1rem;
    margin-bottom: 0.25rem;
}

.export-subtitle {
    font-size: 0.85rem;
    color: var(--dark-gray);
}

/* Update existing filter-btn-export for dropdown indicator */
.filter-btn-export {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

@media (max-width: 768px) {
    .export-menu {
        right: auto;
        left: 0;
        width: calc(100vw - 2rem);
        max-width: 350px;
    }
}

</style>

{% endblock %}

{% block scripts %}
{% comment %} <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script> {% endcomment %}
<script >

    // Enhanced Analytics JavaScript with OEE, Shift-Wise Production, and Cycle Time
// ============================================================================

let chartJsLoaded = false;
let domReady = false;
let analyticsData = null;
let charts = {};

function tryInitialize() {
    if (chartJsLoaded && domReady) {
        console.log('‚úÖ Initializing enhanced analytics dashboard...');
        initializeDashboard();
    }
}

function checkChartJs() {
    if (typeof Chart !== 'undefined') {
        console.log('‚úÖ Chart.js loaded successfully');
        chartJsLoaded = true;
        tryInitialize();
    } else {
        console.log('‚è≥ Waiting for Chart.js...');
        setTimeout(checkChartJs, 100);
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ DOM ready');
        domReady = true;
        tryInitialize();
    });
} else {
    console.log('‚úÖ DOM already ready');
    domReady = true;
}

checkChartJs();

function formatTimestamp(timestamp) {
    if (!timestamp) return '-';
    
    try {
        let date;
        if (timestamp.includes('T') || timestamp.includes('-')) {
            date = new Date(timestamp);
        } else {
            date = new Date(timestamp);
        }
        
        if (isNaN(date.getTime())) {
            return timestamp;
        }
        
        return date.toLocaleString('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
    } catch (e) {
        console.error('Error formatting timestamp:', e, timestamp);
        return timestamp;
    }
}

function initializeDashboard() {
    initializeDateRange();
    applyFilters();
}

function initializeDateRange() {
    const today = new Date();
    const weekAgo = new Date(today);
    weekAgo.setDate(weekAgo.getDate() - 7);
    
    document.getElementById('endDate').valueAsDate = today;
    document.getElementById('startDate').valueAsDate = weekAgo;
}

function handleDateRangeChange() {
    const range = document.getElementById('dateRange').value;
    const startDate = document.getElementById('startDate');
    const endDate = document.getElementById('endDate');
    
    if (range === 'custom') {
        startDate.disabled = false;
        endDate.disabled = false;
        return;
    }
    
    startDate.disabled = true;
    endDate.disabled = true;
    
    const today = new Date();
    endDate.valueAsDate = today;
    
    switch(range) {
        case 'today':
            startDate.valueAsDate = today;
            break;
        case 'yesterday':
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            startDate.valueAsDate = yesterday;
            endDate.valueAsDate = yesterday;
            break;
        case 'week':
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            startDate.valueAsDate = weekAgo;
            break;
        case 'month':
            const monthAgo = new Date(today);
            monthAgo.setDate(monthAgo.getDate() - 30);
            startDate.valueAsDate = monthAgo;
            break;
    }
}

function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

function applyFilters() {
    showLoading();
    
    const filters = {
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        machine: document.getElementById('machineFilter').value,
        status: document.getElementById('statusFilter').value
    };
    
    console.log('üîç Applying filters:', filters);
    
    fetch('/api/analytics/?' + new URLSearchParams(filters))
        .then(response => response.json())
        .then(data => {
            console.log('üìä Received analytics data:', data);
            analyticsData = data;
            updateDashboard(data);
            hideLoading();
        })
        .catch(error => {
            console.error('‚ùå Error fetching analytics:', error);
            hideLoading();
            alert('Error loading analytics data. Please try again.');
        });
}

function resetFilters() {
    document.getElementById('dateRange').value = 'week';
    document.getElementById('machineFilter').value = 'all';
    document.getElementById('statusFilter').value = 'all';
    handleDateRangeChange();
    applyFilters();
}

function updateDashboard(data) {
    updateStatistics(data);
    updateOEEMetrics(data);
    updateShiftData(data);
    updateCharts(data);
    updateMachineBreakdown(data);
    updateModelBreakdown(data);
    updateDetailedTable(data);
}

function updateStatistics(data) {
    const total = data.total_parts || 0;
    const ok = data.ok_parts || 0;
    const ng = data.ng_parts || 0;
    const pending = data.pending_parts || 0;
    
    document.getElementById('totalParts').textContent = total.toLocaleString();
    document.getElementById('okParts').textContent = ok.toLocaleString();
    document.getElementById('ngParts').textContent = ng.toLocaleString();
    
    const okPercent = total > 0 ? ((ok / total) * 100).toFixed(1) : 0;
    const ngPercent = total > 0 ? ((ng / total) * 100).toFixed(1) : 0;
    
    document.getElementById('okPercentage').textContent = okPercent + '%';
    document.getElementById('ngPercentage').textContent = ngPercent + '%';
    
    // NEW: Rejection Rate
    const rejectionRate = data.rejection_rate || 0;
    document.getElementById('rejectionRate').textContent = rejectionRate.toFixed(2) + '%';
    
    // NEW: Average Cycle Time
    const avgCycleTime = data.avg_cycle_time || 0;
    document.getElementById('avgCycleTime').textContent = avgCycleTime.toFixed(2) + ' min';
    
    // NEW: Productivity
    const productivity = data.productivity || 0;
    document.getElementById('productivity').textContent = productivity.toFixed(1) + '%';
}

function updateOEEMetrics(data) {
    const oeeData = data.oee_data || {};
    
    // Overall OEE
    const oee = oeeData.oee || 0;
    const availability = oeeData.availability || 0;
    const performance = oeeData.performance || 0;
    const quality = oeeData.quality || 0;
    const downtime = oeeData.downtime_minutes || 0;
    
    document.getElementById('oeeValue').textContent = oee.toFixed(2) + '%';
    document.getElementById('availabilityValue').textContent = availability.toFixed(2) + '%';
    document.getElementById('performanceValue').textContent = performance.toFixed(2) + '%';
    document.getElementById('qualityValue').textContent = quality.toFixed(2) + '%';
    document.getElementById('downtimeValue').textContent = downtime.toFixed(0) + ' min';
    
    // Color code OEE value
    const oeeElement = document.getElementById('oeeValue');
    if (oee >= 85) {
        oeeElement.style.color = '#00cc66';
    } else if (oee >= 70) {
        oeeElement.style.color = '#ff9933';
    } else {
        oeeElement.style.color = '#cc3333';
    }
}

function updateShiftData(data) {
    const shiftData = data.shift_data || {};
    const oeeData = data.oee_data || {};
    
    // Shift A
    const shiftA = shiftData.A || {ok: 0, ng: 0, pending: 0, total: 0};
    document.getElementById('shiftATotal').textContent = shiftA.total.toLocaleString();
    document.getElementById('shiftAOK').textContent = shiftA.ok.toLocaleString();
    document.getElementById('shiftANG').textContent = shiftA.ng.toLocaleString();
    const shiftAOEE = oeeData.shift_A_oee?.oee || 0;
    document.getElementById('shiftAOEE').textContent = shiftAOEE.toFixed(2) + '%';
    
    // Shift B
    const shiftB = shiftData.B || {ok: 0, ng: 0, pending: 0, total: 0};
    document.getElementById('shiftBTotal').textContent = shiftB.total.toLocaleString();
    document.getElementById('shiftBOK').textContent = shiftB.ok.toLocaleString();
    document.getElementById('shiftBNG').textContent = shiftB.ng.toLocaleString();
    const shiftBOEE = oeeData.shift_B_oee?.oee || 0;
    document.getElementById('shiftBOEE').textContent = shiftBOEE.toFixed(2) + '%';
    
    // Shift C
    const shiftC = shiftData.C || {ok: 0, ng: 0, pending: 0, total: 0};
    document.getElementById('shiftCTotal').textContent = shiftC.total.toLocaleString();
    document.getElementById('shiftCOK').textContent = shiftC.ok.toLocaleString();
    document.getElementById('shiftCNG').textContent = shiftC.ng.toLocaleString();
    const shiftCOEE = oeeData.shift_C_oee?.oee || 0;
    document.getElementById('shiftCOEE').textContent = shiftCOEE.toFixed(2) + '%';
}

function updateCharts(data) {
    if (typeof Chart === 'undefined') {
        console.error('‚ùå Chart.js is not loaded yet');
        setTimeout(() => updateCharts(data), 1000);
        return;
    }
    
    console.log('üìà Updating all charts...');
    
    // Destroy existing charts
    Object.values(charts).forEach(chart => {
        if (chart && typeof chart.destroy === 'function') {
            chart.destroy();
        }
    });
    charts = {};
    
    createOEERadarChart(data);
    createShiftComparisonChart(data);
    createShiftTimelineChart(data);
    createCycleTimeChart(data);
    createRejectionTrendChart(data);
    createStatusPieChart(data);
    createMachineBarChart(data);
    createTimelineChart(data);
    createHourlyChart(data);
    createTrendChart(data);
}

function createOEERadarChart(data) {
    const ctx = document.getElementById('oeeRadarChart');
    if (!ctx) return;
    
    const oeeData = data.oee_data || {};
    
    charts.oeeRadar = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['Availability', 'Performance', 'Quality'],
            datasets: [{
                label: 'Overall OEE Components',
                data: [
                    oeeData.availability || 0,
                    oeeData.performance || 0,
                    oeeData.quality || 0
                ],
                backgroundColor: 'rgba(255, 119, 85, 0.2)',
                borderColor: '#ff7755',
                pointBackgroundColor: '#ff7755',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#ff7755'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

function createShiftComparisonChart(data) {
    const ctx = document.getElementById('shiftComparisonChart');
    if (!ctx) return;
    
    const shiftData = data.shift_data || {};
    
    charts.shiftComparison = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Shift A (06:00-14:00)', 'Shift B (14:00-22:00)', 'Shift C (22:00-06:00)'],
            datasets: [
                {
                    label: 'OK Parts',
                    data: [
                        shiftData.A?.ok || 0,
                        shiftData.B?.ok || 0,
                        shiftData.C?.ok || 0
                    ],
                    backgroundColor: '#00cc66'
                },
                {
                    label: 'NG Parts',
                    data: [
                        shiftData.A?.ng || 0,
                        shiftData.B?.ng || 0,
                        shiftData.C?.ng || 0
                    ],
                    backgroundColor: '#cc3333'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true }
            }
        }
    });
}

function createShiftTimelineChart(data) {
    const ctx = document.getElementById('shiftTimelineChart');
    if (!ctx) return;
    
    const shiftTimeline = data.shift_timeline || {};
    
    charts.shiftTimeline = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: shiftTimeline.labels || [],
            datasets: [
                {
                    label: 'Shift A - OK',
                    data: shiftTimeline.shift_A_ok || [],
                    backgroundColor: '#ffeaa7',
                    stack: 'A'
                },
                {
                    label: 'Shift A - NG',
                    data: shiftTimeline.shift_A_ng || [],
                    backgroundColor: '#fdcb6e',
                    stack: 'A'
                },
                {
                    label: 'Shift B - OK',
                    data: shiftTimeline.shift_B_ok || [],
                    backgroundColor: '#74b9ff',
                    stack: 'B'
                },
                {
                    label: 'Shift B - NG',
                    data: shiftTimeline.shift_B_ng || [],
                    backgroundColor: '#0984e3',
                    stack: 'B'
                },
                {
                    label: 'Shift C - OK',
                    data: shiftTimeline.shift_C_ok || [],
                    backgroundColor: '#a29bfe',
                    stack: 'C'
                },
                {
                    label: 'Shift C - NG',
                    data: shiftTimeline.shift_C_ng || [],
                    backgroundColor: '#6c5ce7',
                    stack: 'C'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12
                    }
                }
            }
        }
    });
}

function createCycleTimeChart(data) {
    const ctx = document.getElementById('cycleTimeChart');
    if (!ctx) return;
    
    const cycleTimeData = data.cycle_time_data || {};
    
    if (!cycleTimeData.labels || cycleTimeData.labels.length === 0) {
        ctx.getContext('2d').fillText('No cycle time data available', 50, 50);
        return;
    }
    
    charts.cycleTime = new Chart(ctx, {
        type: 'line',
        data: {
            labels: cycleTimeData.labels || [],
            datasets: [
                {
                    label: 'Actual Cycle Time',
                    data: cycleTimeData.actual || [],
                    borderColor: '#ff7755',
                    backgroundColor: 'rgba(255, 119, 85, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Standard Cycle Time',
                    data: cycleTimeData.standard || [],
                    borderColor: '#00cc66',
                    backgroundColor: 'rgba(0, 204, 102, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderDash: [5, 5]
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Time (minutes)'
                    }
                }
            }
        }
    });
}

function createRejectionTrendChart(data) {
    const ctx = document.getElementById('rejectionTrendChart');
    if (!ctx) return;
    
    const timelineData = data.timeline_data || {};
    const labels = timelineData.labels || [];
    const okData = timelineData.ok || [];
    const ngData = timelineData.ng || [];
    
    const rejectionRates = labels.map((label, index) => {
        const ok = okData[index] || 0;
        const ng = ngData[index] || 0;
        const total = ok + ng;
        return total > 0 ? ((ng / total) * 100).toFixed(2) : 0;
    });
    
    charts.rejectionTrend = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Rejection Rate %',
                data: rejectionRates,
                borderColor: '#cc3333',
                backgroundColor: 'rgba(204, 51, 51, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

function createStatusPieChart(data) {
    const ctx = document.getElementById('statusPieChart');
    if (!ctx) return;
    
    charts.status = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['OK', 'NG', 'Pending'],
            datasets: [{
                data: [data.ok_parts || 0, data.ng_parts || 0, data.pending_parts || 0],
                backgroundColor: ['#00cc66', '#cc3333', '#ff9933']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function createMachineBarChart(data) {
    const ctx = document.getElementById('machineBarChart');
    if (!ctx) return;
    
    if (!data.machine_stats || data.machine_stats.length === 0) return;
    
    charts.machine = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.machine_stats.map(m => m.display_name || m.machine),
            datasets: [
                {
                    label: 'OK',
                    data: data.machine_stats.map(m => m.ok),
                    backgroundColor: '#00cc66'
                },
                {
                    label: 'NG',
                    data: data.machine_stats.map(m => m.ng),
                    backgroundColor: '#cc3333'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { stacked: false },
                y: { stacked: false, beginAtZero: true }
            }
        }
    });
}

function createTimelineChart(data) {
    const ctx = document.getElementById('timelineChart');
    if (!ctx) return;
    
    const timelineData = data.timeline_data || {};
    
    if (!timelineData.labels || timelineData.labels.length === 0) return;
    
    charts.timeline = new Chart(ctx, {
        type: 'line',
        data: {
            labels: timelineData.labels,
            datasets: [
                {
                    label: 'OK Parts',
                    data: timelineData.ok,
                    borderColor: '#00cc66',
                    backgroundColor: 'rgba(0, 204, 102, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'NG Parts',
                    data: timelineData.ng,
                    borderColor: '#cc3333',
                    backgroundColor: 'rgba(204, 51, 51, 0.1)',
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function createHourlyChart(data) {
    const ctx = document.getElementById('hourlyChart');
    if (!ctx) return;
    
    const hourlyData = data.hourly_data || {};
    
    if (!hourlyData.labels || hourlyData.labels.length === 0) return;
    
    charts.hourly = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: hourlyData.labels,
            datasets: [{
                label: 'Parts Produced',
                data: hourlyData.values,
                backgroundColor: '#ff7755'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function createTrendChart(data) {
    const ctx = document.getElementById('trendChart');
    if (!ctx) return;
    
    const trendData = data.trend_data || {};
    
    if (!trendData.labels || trendData.labels.length === 0) return;
    
    charts.trend = new Chart(ctx, {
        type: 'line',
        data: {
            labels: trendData.labels,
            datasets: [{
                label: 'Yield Rate %',
                data: trendData.values,
                borderColor: '#ff7755',
                backgroundColor: 'rgba(255, 119, 85, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

function updateMachineBreakdown(data) {
    const container = document.getElementById('machineBreakdown');
    container.innerHTML = '';
    
    if (data.machine_stats && data.machine_stats.length > 0) {
        data.machine_stats.forEach(machine => {
            const total = machine.ok + machine.ng + machine.pending;
            const yieldRate = (machine.ok + machine.ng) > 0 
                ? ((machine.ok / (machine.ok + machine.ng)) * 100).toFixed(1) 
                : 0;
            
            container.innerHTML += `
                <div class="machine-stat">
                    <div class="machine-stat-name">${machine.display_name || machine.machine}</div>
                    <div class="machine-stat-value">${total.toLocaleString()}</div>
                    <div style="font-size: 0.75rem; color: var(--dark-gray); margin-top: 0.25rem;">
                        Yield: ${yieldRate}%
                    </div>
                    <div style="font-size: 0.7rem; color: var(--dark-gray); margin-top: 0.25rem;">
                        OK: ${machine.ok} | NG: ${machine.ng}
                    </div>
                </div>
            `;
        });
    } else {
        container.innerHTML = '<p style="text-align: center; color: var(--dark-gray);">No machine data available</p>';
    }
}

function updateModelBreakdown(data) {
    const container = document.getElementById('modelBreakdown');
    container.innerHTML = '';
    
    if (data.model_breakdown && Object.keys(data.model_breakdown).length > 0) {
        Object.entries(data.model_breakdown).forEach(([modelName, stats]) => {
            const total = stats.total;
            const yieldRate = (stats.ok + stats.ng) > 0 
                ? ((stats.ok / (stats.ok + stats.ng)) * 100).toFixed(1) 
                : 0;
            
            container.innerHTML += `
                <div class="machine-stat">
                    <div class="machine-stat-name">${modelName}</div>
                    <div class="machine-stat-value">${total.toLocaleString()}</div>
                    <div style="font-size: 0.75rem; color: var(--dark-gray); margin-top: 0.25rem;">
                        Yield: ${yieldRate}%
                    </div>
                    <div style="font-size: 0.7rem; color: var(--dark-gray); margin-top: 0.25rem;">
                        OK: ${stats.ok} | NG: ${stats.ng}
                    </div>
                </div>
            `;
        });
    } else {
        container.innerHTML = '<p style="text-align: center; color: var(--dark-gray);">No model data available</p>';
    }
}

function updateDetailedTable(data) {
    const tbody = document.getElementById('detailedDataBody');
    tbody.innerHTML = '';
    
    if (data.detailed_data && data.detailed_data.length > 0) {
        data.detailed_data.forEach(record => {
            const timestamp = formatTimestamp(record.timestamp);
            const statusClass = record.status === 'OK' ? 'status-ok' : 
                               record.status === 'NG' ? 'status-ng' : 'status-inprogress';
            
            const cycleTime = record.cycle_time ? `${record.cycle_time.toFixed(2)} min` : '-';
            const shift = record.shift || '-';
            const modelName = record.model_name || 'N/A';
            
            tbody.innerHTML += `
                <tr>
                    <td><small>${record.display_name || record.machine}</small></td>
                    <td><small>${modelName}</small></td>
                    <td><strong>${record.qr_code}</strong></td>
                    <td><small>${timestamp}</small></td>
                    <td><span class="shift-badge shift-${shift.toLowerCase()}">${shift}</span></td>
                    <td><small>${cycleTime}</small></td>
                    <td><span class="status-badge ${statusClass}">${record.status}</span></td>
                </tr>
            `;
        });
    } else {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--dark-gray);">No data available for the selected filters</td></tr>';
    }
}

function searchQRCode() {
    const qrCode = document.getElementById('qrSearchInput').value.trim();
    if (!qrCode) {
        alert('Please enter a QR code');
        return;
    }
    
    showLoading();
    
    fetch(`/api/search/?qr=${encodeURIComponent(qrCode)}`)
        .then(response => response.json())
        .then(data => {
            displaySearchResults(data);
            hideLoading();
        })
        .catch(error => {
            console.error('Error searching:', error);
            hideLoading();
            alert('Error searching QR code');
        });
}

function displaySearchResults(data) {
    const container = document.getElementById('searchResults');
    
    if (!data.results || data.results.length === 0) {
        container.innerHTML = `
            <div style="padding: 1rem; text-align: center; color: var(--dark-gray); background: var(--light-gray); border-radius: 8px; margin-top: 1rem;">
                No results found for QR code: <strong>${data.qr_code}</strong>
            </div>
        `;
        return;
    }
    
    let html = `
        <div style="margin-top: 1rem; padding: 1rem; background: var(--light-gray); border-radius: 8px;">
            <h4 style="margin-bottom: 1rem; color: var(--dark-coral);">Results for: <strong>${data.qr_code}</strong></h4>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Machine</th>
                        <th>Preprocessing Count</th>
                        <th>Postprocessing Count</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.results.forEach(result => {
        html += `
            <tr>
                <td><strong>${result.display_name || result.machine}</strong></td>
                <td>${result.preprocessing_count}</td>
                <td>${result.postprocessing_count}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

function exportData() {
    const filters = {
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        machine: document.getElementById('machineFilter').value,
        status: document.getElementById('statusFilter').value
    };
    
    window.location.href = '/api/analytics/export/?' + new URLSearchParams(filters);
}

function exportCharts() {
    window.print();
}
</script>

<script>
function toggleInfoPanel() {
    const content = document.getElementById('infoPanelContent');
    const toggle = document.getElementById('infoPanelToggle');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.classList.add('rotated');
    } else {
        content.style.display = 'none';
        toggle.classList.remove('rotated');
    }
}

function toggleInfoSection(sectionId) {
    const content = document.getElementById(sectionId);
    const toggle = document.getElementById(sectionId + 'Toggle');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.classList.add('rotated');
    } else {
        content.style.display = 'none';
        toggle.classList.remove('rotated');
    }
}
</script>
<script>
// Toggle export menu
let exportMenuOpen = false;

function toggleExportMenu() {
    const menu = document.getElementById('exportMenu');
    exportMenuOpen = !exportMenuOpen;
    
    if (exportMenuOpen) {
        menu.style.display = 'block';
        // Add click listener to close menu when clicking outside
        setTimeout(() => {
            document.addEventListener('click', closeExportMenuOnClickOutside);
        }, 100);
    } else {
        menu.style.display = 'none';
        document.removeEventListener('click', closeExportMenuOnClickOutside);
    }
}

function closeExportMenuOnClickOutside(event) {
    const menu = document.getElementById('exportMenu');
    const exportDropdown = event.target.closest('.export-dropdown');
    
    if (!exportDropdown && exportMenuOpen) {
        menu.style.display = 'none';
        exportMenuOpen = false;
        document.removeEventListener('click', closeExportMenuOnClickOutside);
    }
}

// Export to Excel (formatted)
function exportExcel() {
    const filters = {
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        machine: document.getElementById('machineFilter').value,
        status: document.getElementById('statusFilter').value
    };
    
    // Close the menu
    document.getElementById('exportMenu').style.display = 'none';
    exportMenuOpen = false;
    
    // Show loading
    showLoading();
    
    // Redirect to Excel export endpoint
    window.location.href = '/api/analytics/export/excel/?' + new URLSearchParams(filters);
    
    // Hide loading after a delay
    setTimeout(() => {
        hideLoading();
    }, 2000);
}

// Export to CSV (keep existing function)
function exportData() {
    const filters = {
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        machine: document.getElementById('machineFilter').value,
        status: document.getElementById('statusFilter').value
    };
    
    // Close the menu
    document.getElementById('exportMenu').style.display = 'none';
    exportMenuOpen = false;
    
    window.location.href = '/api/analytics/export/?' + new URLSearchParams(filters);
}

// Export charts to PDF (keep existing function)
function exportCharts() {
    // Close the menu
    document.getElementById('exportMenu').style.display = 'none';
    exportMenuOpen = false;
    
    window.print();
}
</script>

{% endblock %}